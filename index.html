<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gama 會議室預約系統</title>
    <style>
        /* ……（原樣，略）…… */
    </style>
</head>
<body>
    <div class="container">
        <!-- ……（原樣，略）…… -->
    </div>

    <!-- Modal -->
    <!-- ……（原樣，略）…… -->

    <script>
        // Google Apps Script URL - 已更新為最新版本
        let SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy37YcVMpLYtqvGY5Do4YyQ86SnWbaaSB1aOtZOq7R29zXBR0bq8VveZvRnmfDiPJuxA/exec'; // ★ 修改點：const -> let
        
        // 切換到 Google Sheets 模式
        const USE_LOCAL_STORAGE = false; // 使用 Google Sheets
        
        console.log('系統模式: Google Sheets 模式');
        console.log('Apps Script URL:', SCRIPT_URL);
        
        console.log('系統模式:', USE_LOCAL_STORAGE ? '本地儲存模式（緊急回退）' : 'Google Sheets 模式');
        if (!USE_LOCAL_STORAGE) {
            console.log('Apps Script URL:', SCRIPT_URL);
        }
        
        let currentWeekStart = new Date('2025-08-11');
        let bookings = [];

        // 初始載入預約資料
        if (USE_LOCAL_STORAGE) {
            loadBookingsFromLocal();
        } else {
            loadBookings();
        }

        function showSetupInstructions() {
            document.getElementById('setupModal').style.display = 'block';
        }

        function closeSetupModal() {
            document.getElementById('setupModal').style.display = 'none';
        }

        function saveScriptUrl() {
            const url = document.getElementById('scriptUrl')?.value?.trim();
            if (url) {
                SCRIPT_URL = url; // 這裡需要是 let 才能被重新指定
                localStorage.setItem('gamaBookingScriptUrl', url);
                document.getElementById('setupNotice')?.style && (document.getElementById('setupNotice').style.display = 'none');
                closeSetupModal();
                loadBookings();
                showModal('設定完成', '已成功儲存 Google Apps Script URL，系統現在可以正常使用了！');
            } else {
                alert('請輸入有效的 URL');
            }
        }

        // 本地儲存相關函數（測試用）
        function loadBookingsFromLocal() {
            try {
                const stored = localStorage.getItem('gamaBookings');
                if (stored) {
                    bookings = JSON.parse(stored);
                } else {
                    bookings = [
                        { date: '2025-08-11', room: '小會議室', startTime: '13:00', endTime: '14:00', title: 'Jimmy第一個月報告', organizer: 'Fred' },
                        { date: '2025-08-11', room: '大會議室', startTime: '16:00', endTime: '17:00', title: 'Ace主管分享', organizer: 'Jackal' }
                    ];
                    saveBookingsToLocal();
                }
                updateSchedule();
                updateStats();
            } catch (error) {
                console.error('載入本地資料失敗:', error);
                bookings = [];
            }
        }

        function saveBookingsToLocal() {
            try { localStorage.setItem('gamaBookings', JSON.stringify(bookings)); }
            catch (error) { console.error('儲存本地資料失敗:', error); }
        }

        function saveBookingLocal(booking) {
            bookings.push(booking);
            saveBookingsToLocal();
            updateSchedule();
            updateStats();
            return true;
        }

        // Google Sheets API 相關函數
        async function loadBookings() {
            if (!SCRIPT_URL) {
                showModal('設定錯誤', '請先設定 Google Apps Script URL。');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const data = await response.json();
                if (data.success) {
                    bookings = data.data || [];
                    updateSchedule();
                    updateStats();
                } else {
                    throw new Error(data.error || '載入失敗');
                }
            } catch (error) {
                console.error('載入預約資料失敗:', error);
                showModal('載入失敗', '無法載入預約資料，請檢查網路連線或聯繫管理員。');
            } finally {
                showLoading(false);
            }
        }

        // ★ 修改點：改為「簡單請求」，避免 CORS 預檢
        async function saveBooking(booking) {
            if (!SCRIPT_URL) {
                showModal('系統錯誤', '請聯繫管理員設定系統。');
                return false;
            }
            try {
                showLoading(true);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // 不用 application/json
                    body: JSON.stringify({ action: 'add', data: booking })
                });
                const result = await response.json();
                if (result.success) {
                    bookings.push(booking);
                    updateSchedule();
                    updateStats();
                    return true;
                } else {
                    throw new Error(result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('儲存預約失敗:', error);
                showModal('儲存失敗', `無法儲存預約：${error.message || '請稍後再試'}`);
                return false;
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDayName(date) {
            const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            return days[date.getDay()];
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekDisplay();
            updateSchedule();
        }

        function updateWeekDisplay() {
            const startStr = `${currentWeekStart.getFullYear()}年${currentWeekStart.getMonth() + 1}月${currentWeekStart.getDate()}日`;
            const endDate = new Date(currentWeekStart);
            endDate.setDate(currentWeekStart.getDate() + 6);
            const endStr = `${endDate.getMonth() + 1}月${endDate.getDate()}日`;
            document.getElementById('currentWeek').textContent = `${startStr} - ${endStr}`;
        }

        function updateSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            const weekDates = getWeekDates(currentWeekStart);
            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dayBookings = bookings.filter(booking => booking.date === dateStr);
                if (dayBookings.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="date-cell">${dateStr}</td>
                        <td class="day-cell">${getDayName(date)}</td>
                        <td class="empty-cell" colspan="4" onclick="quickBook('${dateStr}')">點擊快速預約</td>
                    `;
                    scheduleBody.appendChild(row);
                } else {
                    dayBookings.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
                    dayBookings.forEach((booking, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            ${index === 0 ? `<td rowspan="${dayBookings.length}" class="date-cell">${dateStr}</td>` : ''}
                            ${index === 0 ? `<td rowspan="${dayBookings.length}" class="day-cell">${getDayName(date)}</td>` : ''}
                            <td class="room-cell">${booking.room}</td>
                            <td class="time-cell">${booking.startTime}-${booking.endTime}</td>
                            <td class="meeting-cell" onclick="showMeetingDetails('${booking.title}', '${booking.organizer}', '${booking.startTime}-${booking.endTime}', '${booking.room}', '${dateStr}')">
                                <div class="meeting-title">${booking.title}</div>
                                <div class="meeting-organizer">登記者: ${booking.organizer}</div>
                            </td>
                            <td>${booking.organizer}</td>
                        `;
                        scheduleBody.appendChild(row);
                    });
                }
            });
        }

        function quickBook(date) {
            document.getElementById('meetingDate').value = date;
            document.getElementById('meetingTitle').focus();
        }

        function showMeetingDetails(title, organizer, time, room, date) {
            showModal('會議詳情', `
                <strong>會議主題:</strong> ${title}<br>
                <strong>時間:</strong> ${date} ${time}<br>
                <strong>地點:</strong> ${room}<br>
                <strong>登記者:</strong> ${organizer}
            `);
        }

        async function submitBooking() {
            console.log('開始提交預約...');
            const title = document.getElementById('meetingTitle').value.trim();
            const room = document.getElementById('meetingRoom').value;
            const date = document.getElementById('meetingDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const organizer = document.getElementById('organizer').value.trim();

            if (!title) return showModal('預約失敗', '請填寫會議主題。');
            if (!room) return showModal('預約失敗', '請選擇會議室。');
            if (!date) return showModal('預約失敗', '請選擇日期。');
            if (!startTime) return showModal('預約失敗', '請選擇開始時間。');
            if (!endTime) return showModal('預約失敗', '請選擇結束時間。');
            if (!organizer) return showModal('預約失敗', '請填寫登記者。');

            if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
                return showModal('預約失敗', '結束時間必須晚於開始時間。');
            }

            const booking = { date, room, startTime, endTime, title, organizer };

            const conflictBooking = bookings.find(b =>
                b.date === booking.date &&
                b.room === booking.room &&
                timeOverlap(b.startTime, b.endTime, booking.startTime, booking.endTime)
            );
            if (conflictBooking) {
                return showModal('預約失敗', `該時間段已被預約，請選擇其他時間。<br>衝突會議: ${conflictBooking.title}`);
            }

            const success = USE_LOCAL_STORAGE ? saveBookingLocal(booking) : await saveBooking(booking);
            if (success) {
                showModal('預約成功！', `會議主題: ${booking.title}<br>時間: ${booking.date} ${booking.startTime}-${booking.endTime}<br>地點: ${booking.room}<br>登記者: ${booking.organizer}`);
                document.getElementById('meetingTitle').value = '';
                document.getElementById('meetingRoom').value = '';
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
                document.getElementById('organizer').value = '';
                document.getElementById('meetingDate').value = formatDate(currentWeekStart);
            }
        }

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        function timeOverlap(start1, end1, start2, end2) {
            const s1 = timeToMinutes(start1), e1 = timeToMinutes(end1);
            const s2 = timeToMinutes(start2), e2 = timeToMinutes(end2);
            return s1 < e2 && s2 < e1;
        }

        function showModal(title, message) {
            document.querySelector('#bookingModal h3').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('bookingModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('bookingModal').style.display = 'none'; }

        function updateStats() {
            const weekDates = getWeekDates(currentWeekStart);
            const weekBookingsCount = bookings.filter(b => weekDates.some(d => formatDate(d) === b.date)).length;
            const todayBookingsCount = bookings.filter(b => b.date === formatDate(currentWeekStart)).length;
            document.getElementById('weekBookings').textContent = weekBookingsCount;
            document.getElementById('todayBookings').textContent = todayBookingsCount;
        }

        document.querySelector('.close').addEventListener('click', closeModal);
        document.getElementById('bookingModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

        document.addEventListener('DOMContentLoaded', function() {
            updateWeekDisplay();
            updateSchedule();
            updateStats();
            document.getElementById('meetingDate').value = formatDate(currentWeekStart);
        });
    </script>
</body>
</html>
