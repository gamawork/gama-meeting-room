<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gama 會議室預約系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%);
            min-height: 100vh;
            padding: 20px;
        }

.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    
    /* 增強版：更多層陰影 + 邊框 */
    box-shadow: 
        0 20px 40px rgba(0,0,0,0.1),
        0 8px 24px rgba(0,0,0,0.06),
        0 2px 8px rgba(0,0,0,0.04),
        inset 0 0 0 1px rgba(255,255,255,0.05);
    
    border: 1px solid rgba(255,255,255,0.01);
    overflow: hidden;
    
    /* 渲染優化 */
        -webkit-font-smoothing: antialiased;
}

        .header {
            background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.3);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: white;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: white;
        }

        .status-loading {
            background: rgba(251, 191, 36, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.5);
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: 600px;
        }

	.sidebar {
  	  background: #f8f9fe;
   	 padding: 30px 20px;
   	 border-left: 1px solid #e1e5e9;  /* 修改：從 border-right 改為 border-left */
	}
        .booking-form {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
	.booking-form h3 {
    		margin-bottom: 20px;
    		color: #2d3748;
    		display: flex;
    		align-items: center;
    		justify-content: space-between;
   		 white-space: nowrap;
	}

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

      .form-group select,
	.form-group input {
    	width: 100%;
    	padding: 12px;
    	border: 2px solid #e2e8f0;
    	border-radius: 10px;
    	font-size: 16px;
    	transition: all 0.3s ease;
    	font-family: inherit;
    	box-sizing: border-box;
	}
	#meetingRoom,
	#startTime,
	#endTime {
    		padding-right: 40px; /* 為自定義箭頭留空間 */
    
    		/* 隱藏原生箭頭 */
    		-webkit-appearance: none;
    		-moz-appearance: none;
    		appearance: none;
    
    		/* 添加自定義箭頭 */
   		 background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
   		 background-position: right 15px center; /* 箭頭距離右邊 15px */
    		background-repeat: no-repeat;
   		 background-size: 16px 16px;
}


        /* 改進的日期選擇器樣式 */
        .date-picker-container {
            position: relative;
            width: 100%;
        }

        .date-display {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px; /* 重要：防止手機縮放 */
            font-family: inherit;
            background: white;
            cursor: pointer;
            text-align: left;
            color: #2d3748;
            transition: all 0.3s ease;
            box-sizing: border-box;
            
            /* 手機優化 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .date-display:focus {
            outline: none;
            border-color: #2d4874;
            box-shadow: 0 0 0 3px rgba(45, 72, 116, 0.1);
        }

        .date-display:hover {
            border-color: #2d4874;
        }

        .date-display.has-value {
            color: #1a202c;
            font-weight: 500;
        }

        .date-display.placeholder {
            color: #a0aec0;
            font-style: italic;
        }

        .date-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            pointer-events: none;
            font-size: 18px;
        }

        .hidden-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            font-size: 16px; /* 重要：防止手機縮放 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #2d4874;
            box-shadow: 0 0 0 3px rgba(45, 72, 116, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

       	
	.checkbox-group span {
            font-weight: 600;
            color: #2d3748;
        }

        /* 週期預約禁用樣式 */
        .checkbox-group.disabled {
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
        }

        .checkbox-group.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .checkbox-group.disabled span {
            color: #9ca3af;
        }

        .edit-mode-notice {
            font-size: 11px;
            color: #6b7280;
            margin-top: 5px;
            font-style: italic;
            line-height: 1.3;
        }

        .btn {
            background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 72, 116, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .schedule-area {
            padding: 30px;
            overflow-x: auto;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-nav button {
            background: #2d4874;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .date-nav button:hover {
            background: #1a2e4a;
            transform: translateY(-2px);
        }

        .today-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 32px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }

        .today-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .today-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .current-week {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            min-width: 300px;
            text-align: center;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse !important;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            min-width: 1000px;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%);
            color: white;
            padding: 15px 12px;
            font-weight: 600;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .schedule-table th:last-child {
            border-right: none;
        }

        .schedule-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .schedule-table td:last-child {
            border-right: none;
        }

        .schedule-table tbody tr:hover {
            background: #f7fafc;
        }

        .date-cell {
            background: #f0fff4;
            font-weight: 600;
            color: #2d3748;
            vertical-align: middle;
        }

        .day-cell {
            background: #f0fff4;
            font-weight: 600;
            color: #2d3748;
        }

        /* 移除原本的固定背景色 */
        .time-cell {
            font-weight: 600;
            color: #2d3748;
        }

        .room-cell {
            font-weight: 600;
            color: #2d3748;
        }

        .organizer-cell {
            font-weight: 600;
            color: #2d3748;
        }

        .meeting-cell {
            color: #1f2937;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 40px;
        }

        .action-cell {
            padding: 8px;
        }

        .meeting-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

	/* 交錯顏色樣式 - 偶數行（黃色，跟原本時間欄位一樣） */
        .row-even .date-cell,
        .row-even .day-cell,
        .row-even .time-cell,
        .row-even .room-cell,
        .row-even .organizer-cell,
        .row-even .meeting-cell,
        .row-even .action-cell {
                 background: #fef5e7; /* 跟原本時間欄位一樣的黃色 */
    		 border-bottom: 1px solid #cbd5e1 !important; /* 深灰色邊框 */
   		 border-right: 1px solid #cbd5e1 !important;  /* 深灰色邊框 */
        }

        /* 交錯顏色樣式 - 奇數行（淡藍色） */
        .row-odd .date-cell,
	.row-odd .day-cell,
	.row-odd .time-cell,
	.row-odd .room-cell,
	.row-odd .organizer-cell,
	.row-odd .meeting-cell,
	.row-odd .action-cell {
    		background: #dbeafe; /* 淡藍色 */
    		border-bottom: 1px solid #cbd5e1 !important; /* 深灰色邊框 */
    		border-right: 1px solid #cbd5e1 !important;  /* 深灰色邊框 */
	}

        /* Hover 效果 */
        .row-even .date-cell:hover,
        .row-even .day-cell:hover,
        .row-even .time-cell:hover,
        .row-even .room-cell:hover,
        .row-even .organizer-cell:hover,
        .row-even .meeting-cell:hover,
        .row-even .action-cell:hover {
            background: #fed7aa; /* 較深的黃色 */
        }

        .row-odd .date-cell:hover,
        .row-odd .day-cell:hover,
        .row-odd .time-cell:hover,
        .row-odd .room-cell:hover,
        .row-odd .organizer-cell:hover,
        .row-odd .meeting-cell:hover,
        .row-odd .action-cell:hover {
            background: #bfdbfe; /* 較深的藍色 */
        }

        .meeting-title {
            font-weight: 700;
            font-size: 15px;
            color: #111827;
        }

        .empty-cell {
            background: #f8f9fa;
            color: #a0aec0;
            font-style: italic;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center !important;
            vertical-align: middle;
        }

        .empty-cell:hover {
            background: #e8f0fd;
            color: #2d4874;
        }

        .empty-action-cell {
            background: #f8f9fa;
            padding: 8px;
        }

        .calendar-dropdown {
            position: relative;
            display: inline-block;
        }

        .calendar-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
            display: none;
            white-space: nowrap;
        }

        .calendar-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #ddd;
        }

        .calendar-menu::after {
            content: '';
            position: absolute;
            top: -7px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .calendar-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .calendar-option:hover {
            background: #f5f5f5;
        }

        .calendar-option:last-child {
            border-bottom: none;
        }

        .calendar-btn-dropdown {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 5px;
            position: relative;
        }

        .calendar-btn-dropdown:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
        }

        .calendar-btn-dropdown:disabled {
            cursor: not-allowed;
            background: #6c757d;
            transform: none;
            box-shadow: none;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .delete-btn:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }

        .delete-btn:disabled {
            cursor: not-allowed;
            background: #6c757d;
            transform: none;
            box-shadow: none;
        }
	
	/* 編輯模式選擇框樣式 */
        .edit-mode-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1002;
            backdrop-filter: blur(5px);
        }

        .edit-mode-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 480px;
            width: 90%;
            text-align: center;
        }

        .edit-mode-modal h3 {
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.4rem;
        }

        .booking-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .booking-info p {
            margin: 5px 0;
            color: #4a5568;
        }

        .booking-info strong {
            color: #2d3748;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }

        .mode-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
        }

        .mode-btn small {
            display: block;
            font-size: 12px;
            font-weight: 400;
            margin-top: 5px;
            opacity: 0.8;
        }

        .mode-btn-single {
            background: #17a2b8;
            color: white;
            border: 2px solid #17a2b8;
        }

        .mode-btn-single:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .mode-btn-series {
            background: #6f42c1;
            color: white;
            border: 2px solid #6f42c1;
        }

        .mode-btn-series:hover {
            background: #5a32a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        }

        .mode-btn-cancel {
            background: #6c757d;
            color: white;
            border: 2px solid #6c757d;
        }

        .mode-btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .edit-mode-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 3px;
	    margin-right: 3px;   /* 新增：給返回按鈕留出空間 */
        }

        .edit-mode-single {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-mode-series {
            background: #f3e5f5;
            color: #7b1fa2;
        }
	.edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .edit-btn:hover:not(:disabled) {
            background: #138496;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.4);
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }

        .legend {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }

        .available { background: #f8f9fa; }
        .booked-legend { background: linear-gradient(135deg, #b3c5e8 0%, #8db0e6 100%); }

        /* 修正載入遮罩樣式 */
        .table-container {
            position: relative;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            border-radius: 15px;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px;
            background: transparent;
            border-radius: 15px;
            box-shadow: none;
            border: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid #2d4874;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #2d4874;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 移除或隱藏原本的 loading 樣式 */
        .loading {
            display: none !important;
        }

       @media (max-width: 1024px) {
    	.main-content {
       	 grid-template-columns: 1fr;
   	 }
    
   	 .sidebar {
       		 border-left: none;                  /* 修改：移除左邊框 */
       		 border-top: 1px solid #e1e5e9;      /* 修改：改為上邊框 */
       	 order: 2;                            	     /* 新增：在小螢幕時表單在下方 */
    	}
    
    	.schedule-area {
      	  padding: 20px;
       	  order: 1;                            /* 新增：在小螢幕時表格在上方 */
   	 }
	}

        /* 手機響應式優化 */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .sidebar {
                padding: 20px 15px;
            }
            
            .booking-form {
                padding: 15px;
            }
            
            .schedule-area {
                padding: 15px;
            }
            
            .current-week {
                font-size: 1rem;
                min-width: auto;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .modal-message {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #ef4444;
        }

        /* 週期刪除確認模態框 */
        .recurring-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1001;
            backdrop-filter: blur(5px);
        }

        .recurring-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .recurring-modal h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.3rem;
        }

        .recurring-modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #4a5568;
        }

        .recurring-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recurring-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recurring-btn-single {
            background: #fbbf24;
            color: white;
        }

        .recurring-btn-single:hover {
            background: #f59e0b;
            transform: translateY(-2px);
        }

        .recurring-btn-all {
            background: #dc3545;
            color: white;
        }

        .recurring-btn-all:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .recurring-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .recurring-btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #94a3b8, #64748b);
        }    
	/* 編輯衝突模態框基本樣式 */
.edit-conflict-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1003;
    backdrop-filter: blur(5px);
}

.edit-conflict-modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    max-width: 550px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.edit-mode-modal-content.series-conflict {
    max-width: 650px;
}
.edit-conflict-modal h4 {
    margin: 0 0 20px 0;
    color: #dc3545;
    font-size: 1.4rem;
    text-align: center;
    font-weight: 600;
}

.conflict-details {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.conflict-details p {
    margin: 8px 0;
    color: #2d3748;
    line-height: 1.5;
}

.conflict-details strong {
    color: #c53030;
    font-weight: 600;
}

.conflict-summary {
    background: #fffaf0;
    border: 1px solid #fbd38d;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.conflict-summary p {
    margin: 0;
    color: #744210;
    font-weight: 500;
}

.conflict-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 15px 0;
}

.conflict-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f7fafc;
    background: #fefefe;
    color: #2d3748;
    line-height: 1.4;
}

.conflict-item:last-child {
    border-bottom: none;
}

.conflict-item:hover {
    background: #f7fafc;
}

.conflict-item strong {
    color: #c53030;
    font-weight: 600;
}

.conflict-suggestion {
    color: #4a5568;
    font-style: italic;
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3182ce;
}

.conflict-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 25px;
}

.conflict-btn-cancel,
.conflict-btn-skip {
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.conflict-btn-cancel {
    background: #6c757d;
    color: white;
    border: 2px solid #6c757d;
}

.conflict-btn-cancel:hover {
    background: #5a6268;
    border-color: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.conflict-btn-skip {
    background: #ffc107;
    color: #212529;
    border: 2px solid #ffc107;
    font-weight: 700;
}

.conflict-btn-skip:hover {
    background: #e0a800;
    border-color: #e0a800;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

.edit-conflict-modal .close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    cursor: pointer;
    color: #dc3545;
    font-weight: bold;
    line-height: 1;
    transition: color 0.3s ease;
}

.edit-conflict-modal .close:hover {
    color: #a71e2a;
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .edit-conflict-modal-content {
        margin: 20px;
        padding: 20px;
        max-width: none;
        width: calc(100% - 40px);
    }
    
    .series-conflict {
        max-width: none;
    }
    
    .conflict-options {
        gap: 10px;
    }
    
    .conflict-btn-cancel,
    .conflict-btn-skip {
        padding: 14px 16px;
        font-size: 16px;
    }
}

.conflict-list::-webkit-scrollbar {
    width: 6px;
}

.conflict-list::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.conflict-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.conflict-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.edit-conflict-modal {
    animation: fadeIn 0.3s ease-out;
}

.edit-conflict-modal-content {
    animation: slideInDown 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

.edit-cancel-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.edit-cancel-btn:hover {
    background: #5a6268;
    transform: translateY(-1px);
}
.copy-btn {
    background: #d2b48c;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-right: 5px;
}

.copy-btn:hover:not(:disabled) {
    background: #bc9a6a;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(210, 180, 140, 0.4);
}

.copy-btn:disabled {
    cursor: not-allowed;
    background: #6c757d;
    transform: none;
    box-shadow: none;
}
/* 手機端懸浮新增按鈕 - 終極修正版 */
.floating-add-btn {
    /* 最高優先級定位 */
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    
    /* 確保不受任何容器影響 */
    margin: 0 !important;
    padding: 0 !important;
    
    /* 尺寸和外觀 */
    width: 56px !important;
    height: 56px !important;
    background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%) !important;
    border: none !important;
    border-radius: 50% !important;
    color: white !important;
    font-size: 28px !important;
    font-weight: 300 !important;
    line-height: 1 !important;
    
    /* 最高層級 */
    z-index: 999999 !important;
    
    /* 佈局 */
    display: none !important;
    align-items: center !important;
    justify-content: center !important;
    
    /* 互動效果 */
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 16px rgba(45, 72, 116, 0.6) !important;
    
    /* 手機優化 */
    -webkit-tap-highlight-color: transparent !important;
    user-select: none !important;
    pointer-events: auto !important;
    
    /* 強制硬體加速 */
    transform: translateZ(0) !important;
    -webkit-transform: translateZ(0) !important;
    -webkit-backface-visibility: hidden !important;
    backface-visibility: hidden !important;
    
    /* 覆蓋任何可能的繼承樣式 */
    top: auto !important;
    left: auto !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.floating-add-btn:hover,
.floating-add-btn:focus {
    transform: translateY(-2px) translateZ(0) !important;
    box-shadow: 0 6px 20px rgba(45, 72, 116, 0.7) !important;
}

.floating-add-btn:active {
    transform: translateY(0) translateZ(0) !important;
    box-shadow: 0 2px 8px rgba(45, 72, 116, 0.5) !important;
}

/* 手機端強制顯示 - 最高優先級 */
@media (max-width: 768px) {
    .floating-add-btn {
        display: flex !important;
    }
}

/* 小螢幕調整 */
@media (max-width: 480px) {
    .floating-add-btn {
        bottom: 15px !important;
        right: 15px !important;
        width: 50px !important;
        height: 50px !important;
        font-size: 24px !important;
    }
}
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gama 會議室預約系統</h1>
        </div>

<div class="main-content">
            <div class="schedule-area">
                <div class="schedule-header">
                    <div class="date-nav">
                        <button onclick="changeWeek(-1)">◀</button>
                        <div class="current-week" id="currentWeek">本週</div>
                        <button onclick="changeWeek(1)">▶</button>
                        <button class="today-btn" id="todayBtn" onclick="goToToday()">回到本週</button>
                    </div>
                </div>

                <div class="table-container" style="position: relative;">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">載入中...</div>
                        </div>
                    </div>

                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th width="60">日期</th>
                                <th width="60">星期</th>
                                <th width="110">時間</th>
                                <th width="100">會議地點</th>
                                <th width="80">登記者</th>
                                <th width="350">會議主題</th>
                                <th width="200">動作</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <!-- 動態生成內容 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="booking-form">
                    <h3 style="margin-bottom: 20px; color: #2d3748;">新增預約</h3>
                    <div id="bookingForm">
                        <div class="form-group">
                            <label for="meetingDate">日期</label>
                            <div class="date-picker-container">
                                <div class="date-display placeholder" id="dateDisplay">請點擊選擇日期</div>
                                <div class="date-icon">📅</div>
                                <input type="date" id="meetingDate" class="hidden-input">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="meetingTitle">會議主題</label>
                            <input type="text" id="meetingTitle" placeholder="請輸入會議主題">
                        </div>
                        
                        <div class="form-group">
                            <label for="meetingRoom">會議地點</label>
                            <select id="meetingRoom">
                                <option value="">請選擇會議室</option>
                                <option value="小會議室">小會議室</option>
                                <option value="大會議室">大會議室</option>
                                <option value="茶水間">茶水間</option>
                                <option value="囧尼辦公室">囧尼辦公室</option>
                                <option value="街口辦公室">街口辦公室</option>
                                <option value="會客區">會客區</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="startTime">開始時間</label>
                            <select id="startTime">
                                <option value="">請選擇時間</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="endTime">結束時間</label>
                            <select id="endTime">
                                <option value="">請選擇時間</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="organizer">登記者</label>
                            <input type="text" id="organizer" placeholder="請輸入登記者姓名">
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-group">
                                <input type="checkbox" id="recurringBooking">
                                <span>週期預約</span>
                            </label>
                        </div>
                        
                        <div class="form-group" id="recurringOptions" style="display: none;">
                            <label for="recurringType">重複頻率</label>
                            <select id="recurringType">
                                <option value="weekly">每週</option>
                                <option value="biweekly">每雙週</option>
                                <option value="monthly">每月 (每月第幾個週幾)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="monthlyModeOption" style="display: none;">
                            <div class="mode-explanation" id="modeExplanation" style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.4;">
                                相對週日模式 (例如：每月第二個週二)
                            </div>
                        </div>
                        
                        <div class="form-group" id="recurringPeriod" style="display: none;">
                            <label for="recurringWeeks">持續期間</label>
                            <select id="recurringWeeks">
                                <!-- 動態生成選項 -->
                            </select>
                        </div>
                        
                        <button type="button" class="btn" id="submitBtn" onclick="submitBooking()">確認預約</button>
                    </div>
                </div>
            </div>
        </div>
    <!-- Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>預約成功！</h3>
            <div class="modal-message" id="modalMessage"></div>
            
        </div>
    </div>

    <!-- 週期刪除確認模態框 -->
    <div id="recurringDeleteModal" class="recurring-modal">
        <div class="recurring-modal-content">
            <h3>確定要刪除此行程嗎？</h3>
            <div class="recurring-modal-message" id="recurringModalMessage">
                偵測到這是重複行程。
            </div>
            <div class="recurring-modal-buttons">
                <button class="recurring-btn recurring-btn-single" onclick="confirmRecurringDelete('single')">
                    只刪除此行程
                </button>
                <button class="recurring-btn recurring-btn-all" onclick="confirmRecurringDelete('all')">
                    刪除所有將來的行程
                </button>
                <button class="recurring-btn recurring-btn-cancel" onclick="closeRecurringModal()">
                    取消
                </button>
            </div>
        </div>
    </div>

<!-- 單次編輯衝突模態框 -->
<div id="editConflictModal" class="edit-conflict-modal">
    <div class="edit-conflict-modal-content">
        <span class="close" onclick="closeEditConflictModal()">&times;</span>
        <div id="editConflictMessage">
            <!-- 動態填入衝突信息 -->
        </div>
        <div id="editConflictOptions" class="conflict-options">
            <!-- 動態填入選項按鈕 -->
        </div>
    </div>
</div>

<!-- 系列編輯衝突模態框 -->
<div id="seriesEditConflictModal" class="edit-conflict-modal">
    <div class="edit-conflict-modal-content series-conflict">
        <span class="close" onclick="closeSeriesEditConflictModal()">&times;</span>
        <div id="seriesConflictMessage">
            <!-- 動態填入系列衝突信息 -->
        </div>
        <div id="seriesConflictOptions" class="conflict-options">
            <!-- 動態填入選項按鈕 -->
        </div>
    </div>
</div>



    <!-- 直接載入 Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

    <script>
        // Supabase 設定 - 直接設定連線資訊
        const SUPABASE_URL = 'https://vicvccudnqluufsgyznk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpY3ZjY3VkbnFsdXVmc2d5em5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMzkyMDMsImV4cCI6MjA3MDcxNTIwM30.55ZG0B_L6UVJOUteqZ7sPXGHm8DG6K5Qk4xcQ9lF01U';
        
        // 全域變數
        let currentWeekStart = getCurrentWeekStart();
        let todayWeekStart = getCurrentWeekStart(); // 儲存今天所在週的週一日期
        let bookings = [];
        let supabaseClient = null;
        let realtimeSubscription = null;
        let pendingDeleteBooking = null; // 暫存待刪除的預約資訊
	// 編輯功能相關變數
        let currentEditingBooking = null;
        let isEditMode = false;
        let editMode = 'single'; // 'single' 或 'series'
        let pendingEditBooking = null;
        let futureBookingsToEdit = [];

// 編輯預約主函數
        async function editBooking(bookingId, event) {
            if (event) event.stopPropagation();
            
            const targetBooking = bookings.find(b => b.id === bookingId);
            if (!targetBooking) {
                showModal('錯誤', '找不到要編輯的預約');
                return;
            }

            // 顯示載入狀態
            const editBtn = event?.target;
            const originalText = editBtn?.textContent;
            if (editBtn) {
                editBtn.disabled = true;
                editBtn.textContent = '檢測中...';
                editBtn.style.opacity = '0.6';
            }

            try {
                // 偵測是否為週期預約
                const recurringInfo = await detectRecurringBookings(targetBooking);
                
                // 恢復按鈕狀態
                if (editBtn) {
                    editBtn.disabled = false;
                    editBtn.textContent = originalText;
                    editBtn.style.opacity = '1';
                }
                
                if (recurringInfo.isRecurring && recurringInfo.futureBookings.length > 1) {
                    // 顯示編輯模式選擇框
                    showEditModeModal(targetBooking, recurringInfo);
                } else {
                    // 直接開啟單次編輯
                    openEditForm(targetBooking, 'single');
                }
            } catch (error) {
                console.error('偵測週期預約時發生錯誤:', error);
                
                // 恢復按鈕狀態
                if (editBtn) {
                    editBtn.disabled = false;
                    editBtn.textContent = originalText;
                    editBtn.style.opacity = '1';
                }
                
                // 如果偵測失敗，直接編輯
                openEditForm(targetBooking, 'single');
		// 除錯資訊
            console.log('週期預約偵測結果:', {
                targetBooking: targetBooking,
                futureCount: recurringInfo.futureBookings.length,
                futureBookings: recurringInfo.futureBookings,
                intervalType: recurringInfo.intervalType
            });
            }
        }

        // 顯示編輯模式選擇框
        function showEditModeModal(targetBooking, recurringInfo) {
            const modal = document.getElementById('editModeModal');
            const bookingInfo = document.getElementById('editBookingInfo');
            const singleDesc = document.getElementById('singleEditDesc');
            const seriesDesc = document.getElementById('seriesEditDesc');
            
            const futureCount = recurringInfo.futureBookings.length;
            const intervalText = recurringInfo.intervalType === 'weekly' ? '每週' : 
                                 recurringInfo.intervalType === 'biweekly' ? '每雙週' : '每月';
            
            // 計算日期範圍
            const startDate = targetBooking.date;
            const endDate = recurringInfo.futureBookings[futureCount - 1]?.date;
            
            // 填入預約資訊
            bookingInfo.innerHTML = `
                <p><strong>會議主題：</strong>${targetBooking.title}</p>
                <p><strong>時間：</strong>${formatTimeDisplay(targetBooking.startTime)} - ${formatTimeDisplay(targetBooking.endTime)}</p>
                <p><strong>地點：</strong>${targetBooking.room}</p>
                <p><strong>偵測結果：</strong>${intervalText}重複，共 ${futureCount} 個預約</p>
            `;
            
            // 更新按鈕描述
            singleDesc.textContent = `僅修改 ${startDate} 這一場會議`;
            seriesDesc.textContent = `修改從 ${startDate} 開始的 ${futureCount} 場會議 (至 ${endDate})`;
            
            // 暫存編輯資訊
            pendingEditBooking = {
                targetBooking: targetBooking,
                recurringInfo: recurringInfo
            };
            
            modal.style.display = 'block';
        }

        // 確認編輯模式
        function confirmEditMode(mode) {
            if (!pendingEditBooking) return;
            
            const { targetBooking, recurringInfo } = pendingEditBooking;
            closeEditModeModal();
            
            if (mode === 'single') {
                openEditForm(targetBooking, 'single');
            } else if (mode === 'series') {
                openEditForm(targetBooking, 'series', recurringInfo.futureBookings);
            }
        }

	function closeEditModeModal() {
    		const modal = document.getElementById('editModeModal');
    		if (modal) {
        	modal.style.display = 'none';
    	}
    pendingEditBooking = null;
}

// 複製預約功能
// 複製預約功能
function copyBooking(bookingId, event) {
    // 防止事件冒泡
    if (event) {
        event.stopPropagation();
    }
    
    // 找到要複製的預約
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) {
        showNotification('找不到要複製的預約資料', 'warning');
        return;
    }
    
    // 如果正在編輯模式，先取消編輯
    if (isEditMode) {
        console.log('取消編輯模式以進行複製');
        cancelEdit();
    }
    
    // 確保表單處於新增模式
    resetForm();
    
    // 填入除了日期外的所有資料
    document.getElementById('meetingTitle').value = booking.title || '';
    document.getElementById('meetingRoom').value = booking.room || '';
    document.getElementById('organizer').value = booking.organizer || '';
    
    // 設定時間選項（重用現有函數）
    setTimeSelectValue('startTime', booking.startTime);
    setTimeSelectValue('endTime', booking.endTime);
    
    // 確保日期欄位為空並更新顯示
    document.getElementById('meetingDate').value = '';
    updateDateDisplay();
    
    // 確保週期預約未勾選（單次模式）
    const recurringCheckbox = document.getElementById('recurringBooking');
    if (recurringCheckbox) {
        recurringCheckbox.checked = false;
        // 隱藏週期選項
        const recurringOptions = document.getElementById('recurringOptions');
        const recurringPeriod = document.getElementById('recurringPeriod');
        const monthlyModeOption = document.getElementById('monthlyModeOption');
        if (recurringOptions) recurringOptions.style.display = 'none';
        if (recurringPeriod) recurringPeriod.style.display = 'none';
        if (monthlyModeOption) monthlyModeOption.style.display = 'none';
    }
    
    // 確保表單標題和按鈕正確
    const submitBtn = document.getElementById('submitBtn');
    const formTitle = document.querySelector('.booking-form h3');
    if (submitBtn) submitBtn.textContent = '確認預約';
    if (formTitle) formTitle.textContent = '新增預約';
    
    // 顯示成功提示
    showNotification('預約內容已複製，請選擇新的日期', 'success');
    
    // 滾動到表單區域
    document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
    
    console.log('預約複製完成:', {
        originalId: bookingId,
        title: booking.title,
        room: booking.room,
        time: `${booking.startTime}-${booking.endTime}`,
        organizer: booking.organizer
    });
}



        // 開啟編輯表單


function openEditForm(booking, mode = 'single', futureBookings = []) {
    console.log('開啟編輯表單:', { booking, mode, futureBookings });
    
    currentEditingBooking = booking;
    isEditMode = true;
    editMode = mode;
    
    // 重要：正確設定 futureBookingsToEdit
    if (mode === 'series' && futureBookings && futureBookings.length > 0) {
        futureBookingsToEdit = futureBookings;
        console.log('設定系列編輯，影響預約數量:', futureBookingsToEdit.length);
    } else {
        futureBookingsToEdit = [booking];
        console.log('設定單次編輯');
    }
    
	// 載入資料到表單
	document.getElementById('meetingTitle').value = booking.title || '';
	document.getElementById('meetingRoom').value = booking.room || '';
	document.getElementById('meetingDate').value = booking.date || '';
	document.getElementById('organizer').value = booking.organizer || '';

	// 特殊處理時間選項
	setTimeSelectValue('startTime', booking.startTime);
	setTimeSelectValue('endTime', booking.endTime);    
    // 禁用週期相關選項
    const recurringCheckbox = document.getElementById('recurringBooking');
    const checkboxGroup = recurringCheckbox?.closest('.checkbox-group');
    const recurringOptions = document.getElementById('recurringOptions');
    const recurringPeriod = document.getElementById('recurringPeriod');
    const monthlyModeOption = document.getElementById('monthlyModeOption');
    
    if (recurringCheckbox && checkboxGroup) {
        // 取消勾選並禁用
        recurringCheckbox.checked = false;
        recurringCheckbox.disabled = true;
        checkboxGroup.classList.add('disabled');
        
        // 添加說明文字
        let notice = checkboxGroup.querySelector('.edit-mode-notice');
        if (!notice) {
            notice = document.createElement('div');
            notice.className = 'edit-mode-notice';
            notice.textContent = '編輯模式下無法修改週期設定';
            checkboxGroup.appendChild(notice);
        }
    }
    
    // 隱藏週期相關選項
    if (recurringOptions) recurringOptions.style.display = 'none';
    if (recurringPeriod) recurringPeriod.style.display = 'none';
    if (monthlyModeOption) monthlyModeOption.style.display = 'none';
    
    updateDateDisplay();
    updateUIForEditMode();
}

function updateUIForEditMode() {
    const submitBtn = document.getElementById('submitBtn');
    const formTitle = document.querySelector('.booking-form h3');
    
    if (submitBtn) submitBtn.textContent = '💾 儲存變更';
    
    if (formTitle) {
        const modeText = editMode === 'single' ? '單次' : `系列 (${futureBookingsToEdit.length}場)`;
        const modeClass = editMode === 'single' ? 'edit-mode-single' : 'edit-mode-series';
        
        formTitle.innerHTML = `
            <div style="display: flex; align-items: center;">
                編輯預約 
                <span class="edit-mode-indicator ${modeClass}">${modeText}</span>
            </div>
            <button class="edit-cancel-btn" onclick="cancelEdit()">返回</button>
        `;
    }
    
    document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
}

// 取消編輯
function cancelEdit() {
    console.log('取消編輯模式');
    
    currentEditingBooking = null;
    isEditMode = false;
    editMode = 'single';
    futureBookingsToEdit = [];
    
    // 恢復週期預約勾選框狀態
    const recurringCheckbox = document.getElementById('recurringBooking');
    const checkboxGroup = recurringCheckbox?.closest('.checkbox-group');
    
    if (recurringCheckbox && checkboxGroup) {
        recurringCheckbox.disabled = false;
        checkboxGroup.classList.remove('disabled');
        
        // 移除說明文字
        const notice = checkboxGroup.querySelector('.edit-mode-notice');
        if (notice) {
            notice.remove();
        }
    }
    
    resetForm();
    
    const submitBtn = document.getElementById('submitBtn');
    const formTitle = document.querySelector('.booking-form h3');
    
    if (submitBtn) submitBtn.textContent = '確認預約';
    if (formTitle) formTitle.textContent = '新增預約';
}


        // 設備檢測
        function detectDevice() {
            const userAgent = navigator.userAgent;
            return {
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent),
                isIOS: /iPad|iPhone|iPod/.test(userAgent),
                isAndroid: /Android/.test(userAgent),
                touchSupport: 'ontouchstart' in window
            };
        }

        // 計算當前週的週一日期
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=週日, 1=週一, ..., 6=週六
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // 週日的話要往前6天，其他往前(dayOfWeek-1)天
            
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysToSubtract);
            monday.setHours(0, 0, 0, 0); // 設定為當天的00:00:00
            
            console.log('今天:', today.toDateString());
            console.log('本週週一:', monday.toDateString());
            
            return monday;
        }

        // 初始化 Supabase 連接
        function initializeSupabase() {
            try {
                updateStatus('connecting', '🔄 連接中...');
                console.log('開始初始化 Supabase...');
                console.log('Supabase object:', typeof supabase);
                
                // 檢查 Supabase SDK 是否可用
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase SDK 未載入');
                }
                
                // 建立 Supabase 客戶端
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase 客戶端建立成功:', supabaseClient);
                
                // 測試連線
                testConnection();
                
            } catch (error) {
                console.error('Supabase 初始化失敗:', error);
                updateStatus('error', '❌ 初始化失敗');
                showModal('初始化失敗', `無法初始化 Supabase：${error.message}`);
            }
        }

        // 測試連線
        async function testConnection() {
            try {
                console.log('開始測試資料庫連線...');
                
                // 修正查詢語法 - 使用簡單的 select 而不是 count(*)
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.error('資料庫查詢錯誤:', error);
                    throw error;
                }
                
                console.log('資料庫連線測試成功:', data);
                updateStatus('connected', '✅ 已連接');
                
                // 載入資料
                loadBookings();
                
                // 設定即時更新
                setupRealtimeSubscription();
                
            } catch (error) {
                console.error('連線測試失敗:', error);
                updateStatus('error', '❌ 連線測試失敗');
                showModal('連線測試失敗', `無法連接到資料庫：${error.message}<br><br>可能原因：<br>1. 網路連線問題<br>2. 資料表 'bookings' 不存在<br>3. RLS 政策未正確設定<br><br>請檢查 Supabase 設定。`);
            }
        }

        // 更新狀態指示器 (移除顯示，只保留 Console 輸出)
        function updateStatus(status, message) {
            console.log(`狀態更新: ${status} - ${message}`);
        }

        // 設定即時更新訂閱
        function setupRealtimeSubscription() {
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
            }
            
            realtimeSubscription = supabaseClient
                .channel('bookings-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'bookings' },
                    (payload) => {
                        console.log('即時更新:', payload);
                        
                        if (payload.eventType === 'INSERT') {
                            // 新增預約
                            const newBooking = formatBookingFromDB(payload.new);
                            bookings.push(newBooking);
                            updateSchedule();
                            
                            // 顯示通知
                            if (payload.new.organizer !== getCurrentUser()) {
                                showNotification(`新預約：${payload.new.title} (${payload.new.organizer})`);
                            }
                        } else if (payload.eventType === 'DELETE') {
                            // 刪除預約
                            bookings = bookings.filter(b => b.id !== payload.old.id);
                            updateSchedule();
                        } else if (payload.eventType === 'UPDATE') {
                            // 更新預約
                            const index = bookings.findIndex(b => b.id === payload.new.id);
                            if (index !== -1) {
                                bookings[index] = formatBookingFromDB(payload.new);
                                updateSchedule();
                            }
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('即時訂閱狀態:', status);
                });
        }

        // 載入預約資料
async function loadBookings() {
    if (!supabaseClient) {
        showModal('未連接', '資料庫連線尚未建立');
        return;
    }
    
    try {
        showLoading(true);
        updateStatus('loading', '🔄 載入資料...');
        
        // 🔧 修正：使用今天所在週作為固定基準點，而不是 currentWeekStart
        const todayWeekStart = getCurrentWeekStart(); // 固定基準
        
        // 計算查詢範圍（以今天所在週為中心，前後各擴大範圍）
        const startDate = new Date(todayWeekStart);
        startDate.setDate(startDate.getDate() - 30);    // 前30天（約4週）
        const endDate = new Date(todayWeekStart);
        endDate.setDate(endDate.getDate() + 150);        // 後150天（約21週）
        
        console.log('查詢範圍（固定基準）:', {
            基準週: formatDate(todayWeekStart),
            開始日期: formatDate(startDate),
            結束日期: formatDate(endDate),
            當前顯示週: formatDate(currentWeekStart)
        });
        
        const { data, error } = await supabaseClient
            .from('bookings')
            .select('*')
            .gte('date', formatDateForDB(startDate))
            .lte('date', formatDateForDB(endDate))
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });
        
        if (error) {
            throw error;
        }
        
        // 格式化資料
        bookings = data.map(formatBookingFromDB);
        
        updateSchedule();
        updateStatus('connected', '✅ 已連接');
        
        console.log(`載入 ${bookings.length} 筆預約資料（固定範圍）`);
        
    } catch (error) {
        console.error('載入資料失敗:', error);
        updateStatus('error', '❌ 載入失敗');
        showModal('載入失敗', `無法載入預約資料: ${error.message}`);
    } finally {
        showLoading(false);
    }
}

        // 新增預約
        async function saveBooking(booking) {
            if (!supabaseClient) {
                showModal('未連接', '資料庫連線尚未建立');
                return false;
            }
            
            try {
                showLoading(true);
                
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .insert([{
                        date: booking.date,
                        room: booking.room,
                        start_time: booking.startTime,
                        end_time: booking.endTime,
                        title: booking.title,
                        organizer: booking.organizer
                    }])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                console.log('預約儲存成功:', data[0]);
                return true;
                
            } catch (error) {
                console.error('儲存預約失敗:', error);
                showModal('儲存失敗', `無法儲存預約: ${error.message}`);
                return false;
            } finally {
                showLoading(false);
            }
        }

        // 格式化時間顯示 - 只顯示 HH:MM
        function formatTimeDisplay(timeValue) {
            if (!timeValue) return '';
            
            console.log('格式化時間:', timeValue, typeof timeValue);
            
            // 如果是字串且包含冒號，處理 HH:MM:SS 格式
            if (typeof timeValue === 'string' && timeValue.includes(':')) {
                // 直接截取前 5 個字元 (HH:MM)
                const formatted = timeValue.substring(0, 5);
                console.log('時間格式化結果:', timeValue, '->', formatted);
                return formatted;
            }
            
            // 如果是 Date 物件或 ISO 字串
            if (timeValue instanceof Date || (typeof timeValue === 'string' && timeValue.includes('T'))) {
                const date = new Date(timeValue);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const formatted = `${hours}:${minutes}`;
                console.log('時間格式化結果:', timeValue, '->', formatted);
                return formatted;
            }
            
            return timeValue;
        }

        // 資料格式化函數
        function formatBookingFromDB(dbRecord) {
            return {
                id: dbRecord.id,
                date: dbRecord.date,
                room: dbRecord.room,
                startTime: dbRecord.start_time,
                endTime: dbRecord.end_time,
                title: dbRecord.title,
                organizer: dbRecord.organizer
            };
        }

        function formatDateForDB(date) {
            return date.toISOString().split('T')[0];
        }

        // 動態更新持續期間選項
function updateRecurringPeriodOptions() {
    const recurringType = document.getElementById('recurringType').value;
    const recurringWeeksSelect = document.getElementById('recurringWeeks');
    const monthlyModeOption = document.getElementById('monthlyModeOption');
    
    // 清空現有選項
    recurringWeeksSelect.innerHTML = '';
    
    if (recurringType === 'weekly') {
        // 隱藏月模式選項
        monthlyModeOption.style.display = 'none';
        
        // 每週重複的選項
        const weeklyOptions = [
            { value: 2, text: '2週' },
            { value: 3, text: '3週' },
            { value: 4, text: '4週' },
            { value: 6, text: '6週' },
            { value: 8, text: '8週' },
            { value: 12, text: '12週（3個月）' },
            { value: 24, text: '24週（6個月）' },
            { value: 52, text: '52週（1年）' },
            { value: 156, text: '156週（3年）' }
        ];
        
        weeklyOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            recurringWeeksSelect.appendChild(optionElement);
        });
        
        // 預設選擇12週
        recurringWeeksSelect.value = '12';
        
    } else if (recurringType === 'biweekly') {
        // 隱藏月模式選項
        monthlyModeOption.style.display = 'none';
        
        // 每雙週重複的選項
        const biweeklyOptions = [
            { value: 4, text: '4週' },
            { value: 6, text: '6週' },
            { value: 8, text: '8週' },
            { value: 10, text: '10週' },
            { value: 12, text: '12週' },
            { value: 26, text: '6個月（半年）' },
            { value: 52, text: '12個月（1年）' },
            { value: 156, text: '36個月（3年）' }
        ];
        
        biweeklyOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            recurringWeeksSelect.appendChild(optionElement);
        });
        
        // 預設選擇12週
        recurringWeeksSelect.value = '12';
        
    } else if (recurringType === 'monthly') {
        // 顯示月模式選項
        monthlyModeOption.style.display = 'block';
        updateModeExplanation(); // 更新說明文字
        
        // 每月重複的選項 (內部仍使用週數計算)
        const monthlyOptions = [
            { value: 9, text: '2個月' },        // 約9週
            { value: 13, text: '3個月' },       // 約13週
            { value: 26, text: '6個月' },       // 約26週
            { value: 52, text: '12個月（1年）' }, // 52週
            { value: 104, text: '24個月（2年）' }, // 104週
            { value: 156, text: '36個月（3年）' }  // 156週
        ];
        
        monthlyOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            recurringWeeksSelect.appendChild(optionElement);
        });
        
        // 預設選擇12個月
        recurringWeeksSelect.value = '52';
    }
    
    console.log(`持續期間選項已更新為：${recurringType}`);
}
// 更新模式說明文字
        function updateModeExplanation() {
            const dateInput = document.getElementById('meetingDate');
            const explanation = document.getElementById('modeExplanation');
            
            if (!dateInput.value) {
                explanation.textContent = '';
                return;
            }
            
            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDate();
            const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const dayName = dayNames[selectedDate.getDay()];
            
            // 直接使用相對週日模式
            const weekOfMonth = Math.ceil(day / 7);
            const weekNames = ['', '第一個', '第二個', '第三個', '第四個', '第五個'];
            explanation.textContent = `相對週日模式：每月${weekNames[weekOfMonth]}${dayName}`;
            explanation.style.color = '#2d4874';
        }

        // 相對週日日期計算
        function calculateRelativeWeeklyDate(baseDate, monthsToAdd) {
            // 計算是第幾週的週幾
            const weekOfMonth = Math.ceil(baseDate.getDate() / 7);
            const dayOfWeek = baseDate.getDay();
            
            console.log(`基準日期 ${baseDate.toDateString()}: 第${weekOfMonth}週的週${dayOfWeek}`);
            
            // 計算目標月份
            const targetDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + monthsToAdd, 1);
            
            // 找到該月第1個指定週幾的日期
            const firstWeekday = targetDate.getDay();
            const daysToFirstTarget = (dayOfWeek - firstWeekday + 7) % 7;
            
            // 計算第N個指定週幾的日期
            const targetDay = 1 + daysToFirstTarget + (weekOfMonth - 1) * 7;
            
            // 檢查該日期是否存在於該月
            const lastDayOfMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
            
            if (targetDay <= lastDayOfMonth) {
                targetDate.setDate(targetDay);
                return targetDate;
            } else {
                // 如果該月沒有第N個週X，回到上一週
                const fallbackDay = targetDay - 7;
                targetDate.setDate(fallbackDay);
                console.log(`該月沒有第${weekOfMonth}週${dayOfWeek}，調整為第${weekOfMonth-1}週`);
                return targetDate;
            }
        }

        // 固定日期計算 (智慧調整)

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDayName(date) {
            const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            return days[date.getDay()];
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }


// 設定時間選擇器的值，如果選項不存在則動態添加
function setTimeSelectValue(selectId, timeValue) {
    const selectElement = document.getElementById(selectId);
    if (!selectElement || !timeValue) return;
    
    // 檢查選項是否已存在
    const existingOption = Array.from(selectElement.options).find(option => option.value === timeValue);
    
    if (!existingOption) {
        // 如果選項不存在，動態添加
        const newOption = document.createElement('option');
        newOption.value = timeValue;
        newOption.textContent = formatTimeDisplay(timeValue);
        selectElement.appendChild(newOption);
    }
    
    // 設定選中值
    selectElement.value = timeValue;
}

        function initializeTimeSelects() {
            const startSelect = document.getElementById('startTime');
            const endSelect = document.getElementById('endTime');
            
            // 開始時間：09:00 - 18:00
            startSelect.innerHTML = '<option value="">請選擇時間</option>';
            for (let hour = 9; hour <= 18; hour++) {
                startSelect.innerHTML += `<option value="${String(hour).padStart(2, '0')}:00">${String(hour).padStart(2, '0')}:00</option>`;
                if (hour < 18) {
                    startSelect.innerHTML += `<option value="${String(hour).padStart(2, '0')}:30">${String(hour).padStart(2, '0')}:30</option>`;
                }
            }
            
            // 結束時間：09:30 - 18:30
            endSelect.innerHTML = '<option value="">請選擇時間</option>';
            for (let hour = 9; hour <= 18; hour++) {
                if (hour === 9) {
                    // 9點只有30分
                    endSelect.innerHTML += `<option value="09:30">09:30</option>`;
                } else {
                    endSelect.innerHTML += `<option value="${String(hour).padStart(2, '0')}:00">${String(hour).padStart(2, '0')}:00</option>`;
                    endSelect.innerHTML += `<option value="${String(hour).padStart(2, '0')}:30">${String(hour).padStart(2, '0')}:30</option>`;
                }
            }
        }

// 界面更新函數
        function updateSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            if (!scheduleBody) return;
            
            scheduleBody.innerHTML = '';
            const weekDates = getWeekDates(currentWeekStart);
            
            weekDates.forEach((date, dayIndex) => {
                const dateStr = formatDate(date);
                const dayBookings = bookings.filter(booking => booking.date === dateStr);
                
                // 決定該天的顏色類別
                const colorClass = dayIndex % 2 === 0 ? 'row-even' : 'row-odd';
                
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const shortDateDisplay = `${month}/${day}`;
                
                if (dayBookings.length === 0) {
                    const row = document.createElement('tr');
                    row.className = `${colorClass} day-separator`; // 空行也要有分隔線
                    row.innerHTML = `
                        <td class="date-cell">${shortDateDisplay}</td>
                        <td class="day-cell">${getDayName(date)}</td>
                        <td class="empty-cell" colspan="4" onclick="quickBook('${dateStr}')">
                            點選此處 帶入預約日期
                        </td>
                        <td class="empty-action-cell"></td>
                    `;
                    scheduleBody.appendChild(row);
                } else {
                    dayBookings.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
                    
                    dayBookings.forEach((booking, index) => {
                        const row = document.createElement('tr');
                        row.className = colorClass; // 同一天的所有行使用相同顏色
                        
                        // 如果是該天的最後一個預約，添加分隔線
                        if (index === dayBookings.length - 1) {
                            row.classList.add('day-separator');
                        }
                        
                        row.innerHTML = `
                            ${index === 0 ? `<td rowspan="${dayBookings.length}" class="date-cell">${shortDateDisplay}</td>` : ''}
                            ${index === 0 ? `<td rowspan="${dayBookings.length}" class="day-cell">${getDayName(date)}</td>` : ''}
                            <td class="time-cell">${formatTimeDisplay(booking.startTime)}-${formatTimeDisplay(booking.endTime)}</td>
                            <td class="room-cell">${booking.room || '未知'}</td>
                            <td class="organizer-cell">${booking.organizer || '未知'}</td>
                            <td class="meeting-cell" onclick="showMeetingDetails('${booking.title}', '${booking.organizer}', '${booking.startTime}-${booking.endTime}', '${booking.room}', '${dateStr}')">
                                <div class="meeting-title">${booking.title || '無標題'}</div>
                            </td>
                            <td class="action-cell">
    				<div class="action-buttons">
        			<div class="calendar-dropdown">
           			 <button class="calendar-btn-dropdown" onclick="toggleCalendarMenu(event, '${booking.id}')">
              			  日曆 ▼
           			 </button>
           			 <div class="calendar-menu" id="menu-${booking.id}">
             			   <div class="calendar-option" onclick="addToGoogleCalendar('${booking.id}')">
                		 Google 日曆
               			 </div>
               			 <div class="calendar-option" onclick="addToAppleCalendar('${booking.id}')">
                   		 Apple & Outlook 日曆
                		 </div>
           			 </div>
       				 </div>
        			<button class="copy-btn" onclick="copyBooking('${booking.id}', event)">複製</button>
        			<button class="edit-btn" onclick="editBooking('${booking.id}', event)">編輯</button>
        			<button class="delete-btn" onclick="deleteBooking('${booking.id}', event)">刪除</button>
   			   </div>
			   </td>
                        `;
                        scheduleBody.appendChild(row);
                    });
                }
            });
        }
        function changeWeek(direction) {
    // 計算新的週開始日期
    const newWeekStart = new Date(currentWeekStart);
    newWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
    
    // 計算與今天所在週的差距（以週為單位）
    const weeksDiff = Math.round((newWeekStart - todayWeekStart) / (7 * 24 * 60 * 60 * 1000));
    
    // 檢查是否超出範圍：往前最多4週，往後最多20週
    if (weeksDiff < -4 || weeksDiff > 20) {
        console.log(`週數限制：目前差距 ${weeksDiff} 週，超出範圍 (-4 到 +20)`);
        return; // 超出範圍，不執行切換
    }
    
    // 在範圍內，執行切換
    currentWeekStart = newWeekStart;
    updateWeekDisplay();
    updateTodayButtonState();
    updateSchedule();
    
    // 如果切換到沒有資料的週，重新載入
    const weekDates = getWeekDates(currentWeekStart);
    const hasDataForWeek = weekDates.some(date => {
        const dateStr = formatDate(date);
        return bookings.some(booking => booking.date === dateStr);
    });
    
    if (!hasDataForWeek && supabaseClient) {
        loadBookings();
    }
}
        // 回到本週功能
        function goToToday() {
            currentWeekStart = new Date(todayWeekStart);
            updateWeekDisplay();
            updateTodayButtonState();
            updateSchedule();
            
            // 重新載入資料以確保同步
            if (supabaseClient) {
                loadBookings();
            }
        }

        // 更新回到本週按鈕狀態
        function updateTodayButtonState() {
            const todayBtn = document.getElementById('todayBtn');
            if (!todayBtn) return;
            
            // 檢查當前顯示的週是否就是本週
            const isCurrentWeek = currentWeekStart.getTime() === todayWeekStart.getTime();
            
            if (isCurrentWeek) {
                todayBtn.disabled = true;
                todayBtn.textContent = '本週';
            } else {
                todayBtn.disabled = false;
                todayBtn.textContent = '回到本週';
            }
        }

        // 更新週別顯示
        function updateWeekDisplay() {
            const year = currentWeekStart.getFullYear();
            const startMonth = currentWeekStart.getMonth() + 1;
            const startDay = currentWeekStart.getDate();
            
            const endDate = new Date(currentWeekStart);
            endDate.setDate(currentWeekStart.getDate() + 6);
            const endMonth = endDate.getMonth() + 1;
            const endDay = endDate.getDate();
            
            let weekDisplay;
            if (startMonth === endMonth) {
                // 同一個月
                weekDisplay = `${year}年${startMonth}月${startDay}日 - ${endDay}日`;
            } else {
                // 跨月
                weekDisplay = `${year}年${startMonth}月${startDay}日 - ${endMonth}月${endDay}日`;
            }
            
            document.getElementById('currentWeek').textContent = weekDisplay;
            console.log('週別顯示更新為:', weekDisplay);
            
            // 更新回到本週按鈕狀態
            updateTodayButtonState();
        }

        // 改進的日期格式化函數
        function formatDateDisplay(dateString) {
            if (!dateString) return '請點擊選擇日期';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '請點擊選擇日期';
                
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const dayName = dayNames[date.getDay()];
                
                return `${year}年${month}月${day}日 (${dayName})`;
            } catch (error) {
                console.error('日期格式化錯誤:', error);
                return '請點擊選擇日期';
            }
        }

        // 改進的日期更新函數
        function updateDateDisplay() {
            const dateInput = document.getElementById('meetingDate');
            const dateDisplay = document.getElementById('dateDisplay');
            
            if (!dateInput || !dateDisplay) return;
            
            const formattedDate = formatDateDisplay(dateInput.value);
            dateDisplay.textContent = formattedDate;
            
            // 更新樣式
            if (dateInput.value) {
                dateDisplay.classList.remove('placeholder');
                dateDisplay.classList.add('has-value');
            } else {
                dateDisplay.classList.add('placeholder');
                dateDisplay.classList.remove('has-value');
            }
            
            // 如果是月模式且已勾選週期預約，更新說明
            const recurringType = document.getElementById('recurringType');
            const recurringCheckbox = document.getElementById('recurringBooking');
            if (recurringType && recurringCheckbox && 
                recurringType.value === 'monthly' && recurringCheckbox.checked) {
                updateModeExplanation();
            }
            
            console.log('日期已更新:', dateInput.value, '->', formattedDate);
        }

        // 改進的日期選擇器開啟函數
        function openDatePicker() {
            const dateInput = document.getElementById('meetingDate');
            if (!dateInput) return;
            
            const device = detectDevice();
            console.log('開啟日期選擇器, 設備:', device);
            
            try {
                // 方法1: showPicker (支援的瀏覽器)
                if (dateInput.showPicker) {
                    console.log('使用 showPicker');
                    dateInput.showPicker();
                    return;
                }
            } catch (error) {
                console.log('showPicker 失敗:', error.message);
            }
            
            try {
                // 方法2: 程式化點擊
                console.log('使用程式化點擊');
                dateInput.focus();
                dateInput.click();
                
                // 手機額外處理
                if (device.isMobile) {
                    setTimeout(() => {
                        dateInput.focus();
                        if (device.isIOS) {
                            // iOS 特殊處理
                            const event = new Event('click', { bubbles: true });
                            dateInput.dispatchEvent(event);
                        }
                    }, 50);
                }
            } catch (error) {
                console.log('程式化點擊失敗:', error.message);
            }
        }

        function quickBook(date) {
            const dateInput = document.getElementById('meetingDate');
            const dateDisplay = document.getElementById('dateDisplay');
            
            if (dateInput) dateInput.value = date;
            if (dateDisplay) {
                updateDateDisplay(); // 使用改進的更新函數
            }
            
            const titleInput = document.getElementById('meetingTitle');
            if (titleInput) titleInput.focus();
        }

        function showMeetingDetails(title, organizer, time, room, date) {
            showModal('會議詳情', `
                <strong>會議主題:</strong> ${title}<br>
                <strong>時間:</strong> ${date} ${time}<br>
                <strong>地點:</strong> ${room}<br>
                <strong>登記者:</strong> ${organizer}
            `);
        }

        // 偵測週期預約 (直接查詢資料庫版本)
        async function detectRecurringBookings(targetBooking) {
            try {
                console.log('開始偵測週期預約:', targetBooking);
                
                // 直接查詢資料庫中所有相同模式的預約
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .select('*')
                    .eq('title', targetBooking.title)
                    .eq('organizer', targetBooking.organizer)
                    .eq('room', targetBooking.room)
                    .eq('start_time', targetBooking.startTime)
                    .eq('end_time', targetBooking.endTime)
                    .gte('date', targetBooking.date)
                    .order('date', { ascending: true });

                if (error) {
                    console.error('查詢週期預約失敗:', error);
                    return { isRecurring: false, futureBookings: [] };
                }

                const samePatternBookings = data.map(formatBookingFromDB);
                console.log('資料庫中相同模式的預約:', samePatternBookings.length, '筆');
                console.log('預約列表:', samePatternBookings);

                if (samePatternBookings.length <= 1) {
                    return { isRecurring: false, futureBookings: [] };
                }

                // 檢查日期間隔是否規律
                const intervals = [];
                for (let i = 1; i < samePatternBookings.length; i++) {
                    const prevDate = new Date(samePatternBookings[i-1].date);
                    const currentDate = new Date(samePatternBookings[i].date);
                    const diffDays = Math.round((currentDate - prevDate) / (1000 * 60 * 60 * 24));
                    intervals.push(diffDays);
                }

                console.log('日期間隔分析:', intervals);

                // 檢查間隔是否一致
                let isRegular = false;
                let intervalType = 'unknown';

                if (intervals.length > 0) {
                    const firstInterval = intervals[0];
                    
                    // 檢查是否為週期性 (每7天)
                    if (firstInterval === 7 && intervals.every(interval => interval === 7)) {
                        isRegular = true;
                        intervalType = 'weekly';
                    }
			else if (firstInterval === 14 && intervals.every(interval => interval === 14)) {
    			isRegular = true;
    			intervalType = 'biweekly';
			}
                    // 檢查是否為月週期 (28-31天，允許月份天數不同)
                    else if (firstInterval >= 28 && firstInterval <= 31 && 
                             intervals.every(interval => interval >= 28 && interval <= 31)) {
                        isRegular = true;
                        intervalType = 'monthly';
                    }
                    // 檢查是否有大致規律的間隔 (允許一些誤差)
                    else {
                        const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                        const maxDeviation = Math.max(...intervals.map(i => Math.abs(i - avgInterval)));
                        
                        if (maxDeviation <= 2) { // 允許2天誤差
                            isRegular = true;
                            intervalType = avgInterval <= 10 ? 'weekly' : 'monthly';
                        }
                    }
                }

	console.log('週期分析結果:', {
                    isRegular,
                    intervalType,
                    totalCount: samePatternBookings.length
                });
                return {
                    isRecurring: isRegular,
                    futureBookings: samePatternBookings,
                    intervalType: intervalType
                };
            } catch (error) {
                console.error('偵測週期預約時發生錯誤:', error);
                return { isRecurring: false, futureBookings: [] };
            }
        }
        // 刪除預約 (新版本 - 支援非同步週期偵測)
// 刪除預約 (修正語法錯誤版本)
async function deleteBooking(bookingId, event) {
    // 防止事件冒泡
    if (event) {
        event.stopPropagation();
    }
    
    if (!supabaseClient) {
        showModal('未連接', '資料庫連線尚未建立');
        return;
    }
    
    // 找到要刪除的預約
    const targetBooking = bookings.find(b => b.id === bookingId);
    if (!targetBooking) {
        showModal('錯誤', '找不到要刪除的預約');
        return;
    }

    // 顯示載入狀態
    const deleteBtn = event?.target;
    const originalText = deleteBtn?.textContent;
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '檢測中...';
        deleteBtn.style.opacity = '0.6';
    }

    try {
        // 偵測是否為週期預約 (非同步)
        const recurringInfo = await detectRecurringBookings(targetBooking);
        
        // 恢復按鈕狀態
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.textContent = originalText;
            deleteBtn.style.opacity = '1';
        }
        
        if (recurringInfo.isRecurring) {
            // 顯示週期刪除確認對話框
            showRecurringDeleteModal(targetBooking, recurringInfo);
        } else {
            // 普通預約，顯示詳細資訊確認對話框
            showDetailedDeleteConfirm(targetBooking);
        }
    } catch (error) {
        console.error('偵測週期預約時發生錯誤:', error);
        
        // 恢復按鈕狀態
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.textContent = originalText;
            deleteBtn.style.opacity = '1';
        }
        
        // 如果偵測失敗，顯示詳細資訊確認對話框
        showDetailedDeleteConfirm(targetBooking);
    }
}
        
// 顯示週期刪除確認模態框
function showRecurringDeleteModal(targetBooking, recurringInfo) {
    const modal = document.getElementById('recurringDeleteModal');
    const message = document.getElementById('recurringModalMessage');
    
    const futureCount = recurringInfo.futureBookings.length;
    const intervalText = recurringInfo.intervalType === 'weekly' ? '每週' : '每月';
    
    // 找到最後一筆預約的日期
    const lastBookingDate = recurringInfo.futureBookings[futureCount - 1]?.date;
    let lastDateText = '';
    
    if (lastBookingDate) {
        // 格式化最後預約日期為 YYYY年MM月DD日
        const lastDate = new Date(lastBookingDate);
        const year = lastDate.getFullYear();
        const month = lastDate.getMonth() + 1;
        const day = lastDate.getDate();
        lastDateText = `<br>最後一筆預約日：<strong>${year}年${month}月${day}日</strong>`;
    }
    
    message.innerHTML = `
        偵測到這是${intervalText}重複行程。<br>
        <strong>將影響 ${futureCount} 個預約</strong>${lastDateText}<br><br>
        請選擇刪除範圍：
    `;
    
    // 暫存刪除資訊
    pendingDeleteBooking = {
        targetBooking: targetBooking,
        recurringInfo: recurringInfo
    };
    
    modal.style.display = 'block';
}
        // 確認週期刪除
        async function confirmRecurringDelete(type) {
            if (!pendingDeleteBooking) return;
            
            const { targetBooking, recurringInfo } = pendingDeleteBooking;
            let idsToDelete = [];
            
            if (type === 'single') {
                // 只刪除當前這一個
                idsToDelete = [targetBooking.id];
            } else if (type === 'all') {
                // 刪除所有將來的預約
                idsToDelete = recurringInfo.futureBookings.map(b => b.id);
            }
            
            closeRecurringModal();
            
            if (idsToDelete.length > 0) {
                await performDelete(idsToDelete);
            }
        }

        // 執行刪除操作
        async function performDelete(bookingIds, deleteBtn = null) {
            // 設定按鈕狀態
            const originalText = deleteBtn?.textContent;
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = '刪除中...';
                deleteBtn.style.opacity = '0.6';
            }
            
            try {
                showLoading(true);
                
                // 批量刪除
                const { error } = await supabaseClient
                    .from('bookings')
                    .delete()
                    .in('id', bookingIds);
                
                if (error) {
                    throw error;
                }
                
                // 立即更新本地資料
                bookings = bookings.filter(b => !bookingIds.includes(b.id));
                
                // 立即重新渲染表格
                updateSchedule();
                
                const deleteCount = bookingIds.length;
                const message = deleteCount === 1 ? '預約已刪除' : `已刪除 ${deleteCount} 個預約`;
                showNotification(message);
                
                console.log('預約刪除成功，IDs:', bookingIds);
                
            } catch (error) {
                console.error('刪除預約失敗:', error);
                showModal('刪除失敗', `無法刪除預約: ${error.message}`);
                
                // 恢復按鈕狀態
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = originalText;
                    deleteBtn.style.opacity = '1';
                }
            } finally {
                showLoading(false);
            }
        }

        // 階段1：ICS 檔案生成函數
        function generateICS(booking) {
            try {
                // 處理時間格式
                let startTime = booking.startTime;
                let endTime = booking.endTime;
                
                if (startTime && startTime.length > 5) {
                    startTime = startTime.substring(0, 5);
                }
                if (endTime && endTime.length > 5) {
                    endTime = endTime.substring(0, 5);
                }
                
                // 建立日期時間物件
                const startDateTime = new Date(`${booking.date}T${startTime}:00`);
                const endDateTime = new Date(`${booking.date}T${endTime}:00`);
                
                // 檢查日期是否有效
                if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                    throw new Error('無效的日期時間格式');
                }
                
                // 格式化為 ICS 格式 (YYYYMMDDTHHMMSS)
                const formatICSDateTime = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    
                    return `${year}${month}${day}T${hours}${minutes}${seconds}`;
                };
                
                const now = new Date();
                const startFormatted = formatICSDateTime(startDateTime);
                const endFormatted = formatICSDateTime(endDateTime);
                const nowFormatted = formatICSDateTime(now);
                
                // 生成 ICS 內容
                const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Gama//會議室預約系統//TW
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${booking.id}@gama-booking.com
DTSTAMP:${nowFormatted}
DTSTART:${startFormatted}
DTEND:${endFormatted}
SUMMARY:${booking.title || '會議'}
LOCATION:${booking.room || ''}
DESCRIPTION:登記者: ${booking.organizer || '未知'}\\n\\n透過 Gama 會議室預約系統建立
CATEGORIES:會議
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:會議提醒
TRIGGER:-PT15M
END:VALARM
END:VEVENT
END:VCALENDAR`;
                
                return icsContent;
                
            } catch (error) {
                console.error('ICS 生成失敗:', error);
                throw error;
            }
        }

        // 階段1：檔案下載功能
        function downloadICS(icsContent, filename) {
            try {
                // 建立 Blob 物件
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                
                // 建立下載連結
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                
                // 觸發下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理 URL
                URL.revokeObjectURL(url);
                
                console.log('ICS 檔案下載成功:', filename);
                
            } catch (error) {
                console.error('檔案下載失敗:', error);
                throw error;
            }
        }

        // 階段2：智慧提示訊息
        function showSmartNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 2000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 300px;
                font-size: 14px;
                line-height: 1.4;
            `;
            
            // 根據類型設定顏色
            switch(type) {
                case 'success':
                    notification.style.background = '#28a745';
                    notification.style.color = 'white';
                    break;
                case 'info':
                    notification.style.background = '#17a2b8';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.background = '#ffc107';
                    notification.style.color = '#212529';
                    break;
                default:
                    notification.style.background = '#28a745';
                    notification.style.color = 'white';
            }
            
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // 階段2：下拉選單整合
        function toggleCalendarMenu(event, bookingId) {
            event.stopPropagation();
            
            // 隱藏其他開啟的選單
            document.querySelectorAll('.calendar-menu').forEach(menu => {
                if (menu.id !== `menu-${bookingId}`) {
                    menu.style.display = 'none';
                }
            });
            
            // 切換當前選單
            const menu = document.getElementById(`menu-${bookingId}`);
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        }

        // 隱藏所有選單
        function hideAllCalendarMenus() {
            document.querySelectorAll('.calendar-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }

       

// 修改原有的 Google 日曆函數
async function addToGoogleCalendar(bookingId) {
    hideAllCalendarMenus();
    
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) {
        showSmartNotification('找不到預約資料', 'warning');
        return;
    }
    
    try {
        const recurringInfo = await detectRecurringBookings(booking);
        
        // 修正：加強週期預約資料驗證
        const isValidRecurring = recurringInfo.isRecurring && 
                                recurringInfo.futureBookings && 
                                Array.isArray(recurringInfo.futureBookings) &&
                                recurringInfo.futureBookings.length > 1 &&
                                recurringInfo.intervalType &&
                                ['weekly', 'biweekly', 'monthly'].includes(recurringInfo.intervalType);
        
        if (isValidRecurring) {
            console.log('有效週期預約，創建重複事件');
            await createRecurringGoogleCalendarEvent(booking, recurringInfo);
        } else {
            console.log('單次預約或週期資料無效，使用單次模式');
            await createSingleGoogleCalendarEvent(booking);
        }
        
    } catch (error) {
        console.error('加入 Google 日曆失敗:', error);
        // 錯誤時回退到單次預約
        console.log('發生錯誤，回退到單次預約模式');
        try {
            await createSingleGoogleCalendarEvent(booking);
        } catch (fallbackError) {
            showSmartNotification(`加入 Google 日曆失敗: ${fallbackError.message}`, 'warning');
        }
    }
}

// 新增：創建單次 Google Calendar 事件（重構現有邏輯）
async function createSingleGoogleCalendarEvent(booking) {
    // 處理時間格式
    let startTime = booking.startTime;
    let endTime = booking.endTime;
    
    if (startTime && startTime.length > 5) {
        startTime = startTime.substring(0, 5);
    }
    if (endTime && endTime.length > 5) {
        endTime = endTime.substring(0, 5);
    }
    
    // 建立日期時間物件
    const startDateTime = new Date(`${booking.date}T${startTime}:00`);
    const endDateTime = new Date(`${booking.date}T${endTime}:00`);
    
    if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
        throw new Error(`無效的日期時間格式`);
    }
    
    // 格式化為 Google Calendar 格式
    const formatGoogleDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        
        return `${year}${month}${day}T${hours}${minutes}${seconds}`;
    };
    
    const startFormatted = formatGoogleDate(startDateTime);
    const endFormatted = formatGoogleDate(endDateTime);
    
    // 建立 Google Calendar URL
    const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: booking.title || '會議',
        dates: `${startFormatted}/${endFormatted}`,
        location: booking.room || '',
        details: `登記者: ${booking.organizer || '未知'}\n\n透過 Gama 會議室預約系統建立`
    });
    
    const googleCalendarUrl = `https://calendar.google.com/calendar/render?${params.toString()}`;
    
    // 在新視窗開啟 Google Calendar
    window.open(googleCalendarUrl, '_blank');
    
    showSmartNotification('已開啟 Google 日曆', 'success');
}

// 新增：創建週期 Google Calendar 事件
async function createRecurringGoogleCalendarEvent(booking, recurringInfo) {
    // 處理時間格式
    let startTime = booking.startTime;
    let endTime = booking.endTime;
    
    if (startTime && startTime.length > 5) {
        startTime = startTime.substring(0, 5);
    }
    if (endTime && endTime.length > 5) {
        endTime = endTime.substring(0, 5);
    }
    
    // 建立開始日期時間物件
    const startDateTime = new Date(`${booking.date}T${startTime}:00`);
    const endDateTime = new Date(`${booking.date}T${endTime}:00`);
    
    if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
        throw new Error(`無效的日期時間格式`);
    }
    
    // 格式化為 Google Calendar 格式
    const formatGoogleDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        
        return `${year}${month}${day}T${hours}${minutes}${seconds}`;
    };
    
    const startFormatted = formatGoogleDate(startDateTime);
    const endFormatted = formatGoogleDate(endDateTime);
    
    // 生成 RRULE
    const rrule = generateGoogleRRULE(recurringInfo, startDateTime);
    
    // 建立 Google Calendar URL with RRULE
    const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: booking.title || '會議',
        dates: `${startFormatted}/${endFormatted}`,
        location: booking.room || '',
        details: `登記者: ${booking.organizer || '未知'}\n\n週期預約，共 ${recurringInfo.futureBookings.length} 場\n透過 Gama 會議室預約系統建立`,
        recur: rrule
    });
    
    const googleCalendarUrl = `https://calendar.google.com/calendar/render?${params.toString()}`;
    
    // 在新視窗開啟 Google Calendar
    window.open(googleCalendarUrl, '_blank');
    
    showSmartNotification(`已開啟 Google 日曆 (${recurringInfo.futureBookings.length} 場週期會議)`, 'success');
}

// 新增：生成 Google Calendar RRULE
function generateGoogleRRULE(recurringInfo, startDateTime) {
    const intervalType = recurringInfo.intervalType;
    const count = recurringInfo.futureBookings.length;
    
    switch (intervalType) {
        case 'weekly':
            return `RRULE:FREQ=WEEKLY;COUNT=${count}`;
            
        case 'biweekly':
            return `RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=${count}`;
            
        case 'monthly':
            // 修正：使用傳入的 startDateTime 而不是未定義的變數
            const dayOfWeek = startDateTime.getDay();
            const weekOfMonth = Math.ceil(startDateTime.getDate() / 7);
            
            const dayNames = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
            const dayName = dayNames[dayOfWeek];
            
            // 檢查是否為月末週
            const lastDayOfMonth = new Date(startDateTime.getFullYear(), startDateTime.getMonth() + 1, 0).getDate();
            const isLastWeek = startDateTime.getDate() > lastDayOfMonth - 7;
            
            if (isLastWeek && weekOfMonth === 5) {
                return `RRULE:FREQ=MONTHLY;COUNT=${count};BYDAY=${dayName};BYSETPOS=-1`;
            } else {
                return `RRULE:FREQ=MONTHLY;COUNT=${count};BYDAY=${dayName};BYSETPOS=${weekOfMonth}`;
            }
            
        default:
            return `RRULE:FREQ=WEEKLY;COUNT=${count}`;
    }
}


// addToAppleCalendar 函數
async function addToAppleCalendar(bookingId) {
    hideAllCalendarMenus();
    
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) {
        showSmartNotification('找不到預約資料', 'warning');
        return;
    }
    
    try {
        const recurringInfo = await detectRecurringBookings(booking);
        const device = detectDevice();
        
        // 修正：同樣的週期預約資料驗證
        const isValidRecurring = recurringInfo.isRecurring && 
                                recurringInfo.futureBookings && 
                                Array.isArray(recurringInfo.futureBookings) &&
                                recurringInfo.futureBookings.length > 1 &&
                                recurringInfo.intervalType &&
                                ['weekly', 'biweekly', 'monthly'].includes(recurringInfo.intervalType);
        
        if (isValidRecurring) {
            console.log('有效週期預約，生成週期 ICS');
            const icsContent = generateRecurringICS(booking, recurringInfo);
            const filename = `${booking.title || '會議'}_週期預約_${booking.date}.ics`;
            
            downloadICS(icsContent, filename);
            
            if (device.isIOS) {
                showSmartNotification(`週期預約檔案已下載 (${recurringInfo.futureBookings.length} 場)，請點擊檔案加入日曆`, 'success', 5000);
            } else if (device.isAndroid) {
                showSmartNotification(`週期預約檔案已下載 (${recurringInfo.futureBookings.length} 場)，請用日曆 App 開啟`, 'info', 5000);
            } else {
                showSmartNotification(`週期預約 ICS 檔案已下載 (${recurringInfo.futureBookings.length} 場)，請用日曆軟體開啟`, 'info', 5000);
            }
        } else {
            console.log('單次預約或週期資料無效，使用單次模式');
            const icsContent = generateICS(booking);
            const filename = `${booking.title || '會議'}_${booking.date}.ics`;
            
            downloadICS(icsContent, filename);
            
            if (device.isIOS) {
                showSmartNotification('檔案已下載，請點擊檔案加入日曆', 'success', 5000);
            } else if (device.isAndroid) {
                showSmartNotification('檔案已下載，請用日曆 App 開啟', 'info', 5000);
            } else {
                showSmartNotification('ICS 檔案已下載，請用日曆軟體開啟', 'info', 5000);
            }
        }
        
    } catch (error) {
        console.error('加入 Apple 日曆失敗:', error);
        // 錯誤時回退到單次預約
        console.log('發生錯誤，回退到單次預約模式');
        try {
            const icsContent = generateICS(booking);
            const filename = `${booking.title || '會議'}_${booking.date}.ics`;
            downloadICS(icsContent, filename);
            showSmartNotification('已回退為單次預約模式並下載 ICS 檔案', 'info', 5000);
        } catch (fallbackError) {
            showSmartNotification(`加入 Apple 日曆失敗: ${fallbackError.message}`, 'warning');
        }
    }
}

// 新增：生成週期 ICS 檔案
function generateRecurringICS(booking, recurringInfo) {
    try {
        // 處理時間格式
        let startTime = booking.startTime;
        let endTime = booking.endTime;
        
        if (startTime && startTime.length > 5) {
            startTime = startTime.substring(0, 5);
        }
        if (endTime && endTime.length > 5) {
            endTime = endTime.substring(0, 5);
        }
        
        // 建立日期時間物件
        const startDateTime = new Date(`${booking.date}T${startTime}:00`);
        const endDateTime = new Date(`${booking.date}T${endTime}:00`);
        
        // 檢查日期是否有效
        if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
            throw new Error('無效的日期時間格式');
        }
        
        // 格式化為 ICS 格式 (YYYYMMDDTHHMMSS)
        const formatICSDateTime = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        };
        
        const now = new Date();
        const startFormatted = formatICSDateTime(startDateTime);
        const endFormatted = formatICSDateTime(endDateTime);
        const nowFormatted = formatICSDateTime(now);
        
// 生成 ICS RRULE
const rrule = generateICSRRULE(recurringInfo);

// 生成 ICS 內容
const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Gama//會議室預約系統//TW
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${booking.id}-recurring@gama-booking.com
DTSTAMP:${nowFormatted}
DTSTART:${startFormatted}
DTEND:${endFormatted}
${rrule}
SUMMARY:${booking.title || '會議'}
LOCATION:${booking.room || ''}
DESCRIPTION:登記者: ${booking.organizer || '未知'}\\n\\n週期預約，共 ${recurringInfo.futureBookings.length} 場\\n透過 Gama 會議室預約系統建立
CATEGORIES:會議
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:會議提醒
TRIGGER:-PT15M
END:VALARM
END:VEVENT
END:VCALENDAR`;        
        return icsContent;
        
    } catch (error) {
        console.error('週期 ICS 生成失敗:', error);
        throw error;
    }
}

// 7. 新增：生成 ICS RRULE
function generateICSRRULE(recurringInfo) {
    const intervalType = recurringInfo.intervalType;
    const count = recurringInfo.futureBookings.length;
    
    switch (intervalType) {
        case 'weekly':
            return `RRULE:FREQ=WEEKLY;COUNT=${count}`;
        case 'biweekly':
            return `RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=${count}`;
        case 'monthly':
            // 使用 recurringInfo 中的資料
            const firstDate = new Date(recurringInfo.futureBookings[0].date);
            const dayOfWeek = firstDate.getDay();
            const weekOfMonth = Math.ceil(firstDate.getDate() / 7);
            
            const dayNames = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
            const dayName = dayNames[dayOfWeek];
            
            return `RRULE:FREQ=MONTHLY;COUNT=${count};BYDAY=${dayName};BYSETPOS=${weekOfMonth}`;
        default:
            return `RRULE:FREQ=WEEKLY;COUNT=${count}`;
    }
}

        // 關閉週期刪除模態框
        function closeRecurringModal() {
            document.getElementById('recurringDeleteModal').style.display = 'none';
            pendingDeleteBooking = null;
        }
// 顯示詳細刪除確認對話框
function showDetailedDeleteConfirm(booking) {
    const message = `
        <strong>會議主題：</strong>${booking.title || '無標題'}<br>
        <strong>時間：</strong>${booking.date} ${formatTimeDisplay(booking.startTime)}-${formatTimeDisplay(booking.endTime)}<br>
        <strong>地點：</strong>${booking.room || '未知'}<br>
        <strong>登記者：</strong>${booking.organizer || '未知'}
    `;
    
    showModal('會議詳情', message, () => {
        // 確認刪除回調
        performDelete([booking.id]);
    });
}

        // 預約提交函數
        // 衝突檢查（即時查詢資料庫）
async function checkRecurringConflicts(recurringDates, room, startTime, endTime, excludeIds = []) {
    if (!supabaseClient) {
        console.warn('資料庫客戶端未初始化，跳過衝突檢測');
        return [];
    }
    
    try {
        console.log('開始衝突檢測:', { recurringDates, room, startTime, endTime, excludeIds });
        
        const { data, error } = await supabaseClient
            .from('bookings')
            .select('*')
            .in('date', recurringDates)
            .eq('room', room);
        
        if (error) {
            console.error('衝突檢查失敗:', error);
            throw error;
        }
        
        console.log('查詢到的相同會議室預約:', data);
        
        const conflicts = [];
        data.forEach(booking => {
            // 排除指定的預約ID
            if (excludeIds.includes(booking.id)) {
                console.log('排除自己的預約:', booking.id);
                return;
            }
            
            const existingStart = booking.start_time;
            const existingEnd = booking.end_time;
            
            console.log('檢查時間重疊:', {
                existing: `${existingStart}-${existingEnd}`,
                new: `${startTime}-${endTime}`
            });
            
            if (timeOverlap(existingStart, existingEnd, startTime, endTime)) {
                console.log('發現衝突:', booking);
                conflicts.push({
                    date: booking.date,
                    booking: formatBookingFromDB(booking)
                });
            }
        });
        
        console.log(`衝突檢測完成，發現 ${conflicts.length} 個衝突`);
        return conflicts;
        
    } catch (error) {
        console.error('衝突檢查錯誤:', error);
        throw new Error(`衝突檢測失敗: ${error.message}`);
    }
}

async function checkSingleEditConflicts(bookingId, date, room, startTime, endTime) {
    try {
        console.log('檢查單次編輯衝突:', { bookingId, date, room, startTime, endTime });
        
        const conflicts = await checkRecurringConflicts([date], room, startTime, endTime, [bookingId]);
        
        return conflicts;
    } catch (error) {
        console.error('單次編輯衝突檢查失敗:', error);
        throw error;
    }
}

// 5.2 系列編輯衝突檢查
async function checkSeriesEditConflicts(seriesIds, dates, room, startTime, endTime) {
    try {
        console.log('檢查系列編輯衝突:', { seriesIds, dates, room, startTime, endTime });
        
        const conflicts = await checkRecurringConflicts(dates, room, startTime, endTime, seriesIds);
        
        const conflictStats = {
            totalDates: dates.length,
            conflictDates: conflicts.length,
            successDates: dates.length - conflicts.length,
            conflicts: conflicts
        };
        
        console.log('系列編輯衝突統計:', conflictStats);
        return conflictStats;
        
    } catch (error) {
        console.error('系列編輯衝突檢查失敗:', error);
        throw error;
    }
}

// 5.3 顯示單次編輯衝突模態框
function showEditConflictModal(conflicts, isSeriesEdit = false) {
    const modal = document.getElementById('editConflictModal');
    const message = document.getElementById('editConflictMessage');
    const options = document.getElementById('editConflictOptions');
    
    if (!modal) {
        console.error('找不到編輯衝突模態框');
        return;
    }
    
    const conflict = conflicts[0];
    message.innerHTML = `
        <h4>預約衝突</h4>
        <div class="conflict-details">
            <p><strong>衝突日期：</strong>${conflict.date}</p>
            <p><strong>會議室：</strong>${conflict.booking.room}</p>
            <p><strong>現有時間：</strong>${formatTimeDisplay(conflict.booking.startTime)} - ${formatTimeDisplay(conflict.booking.endTime)}</p>
            <p><strong>現有會議：</strong>${conflict.booking.title}</p>
            <p><strong>預約者：</strong>${conflict.booking.organizer}</p>
        </div>
        <p class="conflict-suggestion">請修改您的預約時間或選擇其他會議室。</p>
    `;
    
    options.innerHTML = `
        <button class="btn conflict-btn-cancel" onclick="closeEditConflictModal()">返回修改</button>
    `;
    
    modal.style.display = 'block';
}

// 5.4 顯示系列編輯衝突模態框
function showSeriesEditConflictModal(conflictStats) {
    const modal = document.getElementById('seriesEditConflictModal');
    const message = document.getElementById('seriesConflictMessage');
    const options = document.getElementById('seriesConflictOptions');
    
    if (!modal) {
        console.error('找不到系列編輯衝突模態框');
        return;
    }
    
    let conflictList = '';
    conflictStats.conflicts.forEach(conflict => {
        conflictList += `
            <div class="conflict-item">
                <strong>${conflict.date}</strong> - ${conflict.booking.title} (${formatTimeDisplay(conflict.booking.startTime)}-${formatTimeDisplay(conflict.booking.endTime)})
            </div>
        `;
    });
    
    message.innerHTML = `
        <h4>系列編輯衝突</h4>
        <div class="conflict-summary">
            <p>共 ${conflictStats.totalDates} 個預約，其中 ${conflictStats.conflictDates} 個產生衝突：</p>
        </div>
        <div class="conflict-list">
            ${conflictList}
        </div>
        <p class="conflict-suggestion">請修改您的預約時間或選擇其他會議室。</p>
    `;
    
    window.pendingSeriesConflictStats = conflictStats;
    
    options.innerHTML = `
         <button class="btn conflict-btn-cancel" onclick="closeSeriesEditConflictModal()">返回修改</button>
    `;
    
    modal.style.display = 'block';
}

// 5.5 確認系列編輯處理衝突
async function confirmSeriesEditWithConflicts(action) {
    if (action === 'skip' && window.pendingSeriesConflictStats) {
        const stats = window.pendingSeriesConflictStats;
        
        const conflictDates = stats.conflicts.map(c => c.date);
        const nonConflictBookings = futureBookingsToEdit.filter(booking => 
            !conflictDates.includes(booking.date)
        );
        
        if (nonConflictBookings.length === 0) {
            showModal('無法更新', '所有日期都有衝突，無法執行更新。');
            closeSeriesEditConflictModal();
            return;
        }
        
        const confirmed = confirm(
            `確定要跳過 ${stats.conflictDates} 個衝突日期，更新剩餘 ${nonConflictBookings.length} 個預約嗎？`
        );
        
        if (confirmed) {
            closeSeriesEditConflictModal();
            await updatePartialSeriesBookings(nonConflictBookings);
        }
    }
}

// 5.6 部分系列更新
async function updatePartialSeriesBookings(bookingsToUpdate) {
    try {
        showLoading(true);
        
        const title = document.getElementById('meetingTitle').value.trim();
        const room = document.getElementById('meetingRoom').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const organizer = document.getElementById('organizer').value.trim();
        
        let successCount = 0;
        let failedCount = 0;
        
        for (const booking of bookingsToUpdate) {
            try {
                const { error } = await supabaseClient
                    .from('bookings')
                    .update({
                        title: title,
                        room: room,
                        start_time: startTime,
                        end_time: endTime,
                        organizer: organizer
                    })
                    .eq('id', booking.id);
                
                if (error) {
                    console.error(`更新預約 ${booking.id} 失敗:`, error);
                    failedCount++;
                } else {
                    console.log(`更新預約 ${booking.id} 成功`);
                    successCount++;
                }
            } catch (error) {
                console.error(`更新預約 ${booking.id} 時發生錯誤:`, error);
                failedCount++;
            }
        }
        
        const skippedCount = futureBookingsToEdit.length - bookingsToUpdate.length;
        let message = `部分更新完成<br><br>`;
        message += `會議主題：${title}<br>`;
        message += `地點：${room}<br>`;
        message += `時間：${startTime}-${endTime}<br>`;
        message += `登記者：${organizer}<br><br>`;
        message += `成功更新：${successCount} 個預約<br>`;
        message += `跳過衝突：${skippedCount} 個預約<br>`;
        
        if (failedCount > 0) {
            message += `更新失敗：${failedCount} 個預約<br>`;
        }
        
        showModal('部分更新完成', message);
        cancelEdit();
        setTimeout(() => loadBookings(), 1000);
        
    } catch (error) {
        console.error('部分系列更新失敗:', error);
        showModal('更新失敗', `部分更新時發生錯誤：${error.message}`);
    } finally {
        showLoading(false);
    }
}

// 5.7 關閉衝突模態框
function closeEditConflictModal() {
    const modal = document.getElementById('editConflictModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function closeSeriesEditConflictModal() {
    const modal = document.getElementById('seriesEditConflictModal');
    if (modal) {
        modal.style.display = 'none';
    }
    window.pendingSeriesConflictStats = null;
}

// 5.8 設定衝突事件監聽器
function setupEditConflictEventListeners() {
    const editConflictModal = document.getElementById('editConflictModal');
    if (editConflictModal) {
        editConflictModal.addEventListener('click', function(e) {
            if (e.target === this) closeEditConflictModal();
        });
    }
    
    const seriesEditConflictModal = document.getElementById('seriesEditConflictModal');
    if (seriesEditConflictModal) {
        seriesEditConflictModal.addEventListener('click', function(e) {
            if (e.target === this) closeSeriesEditConflictModal();
        });
    }
}



// 時間重疊檢測函數
function timeOverlap(start1, end1, start2, end2) {
    const s1 = timeToMinutes(start1);
    const e1 = timeToMinutes(end1);
    const s2 = timeToMinutes(start2);
    const e2 = timeToMinutes(end2);
    
    const overlap = s1 < e2 && s2 < e1;
    
    console.log('時間重疊檢測:', {
        time1: `${start1}-${end1} (${s1}-${e1}分鐘)`,
        time2: `${start2}-${end2} (${s2}-${e2}分鐘)`,
        overlap: overlap
    });
    
    return overlap;
}

// 重設表單函數 - 清空所有表單欄位並恢復預設狀態
function resetForm() {
    try {
        console.log('開始重設表單...');
        
        // 清空基本欄位
        const meetingTitle = document.getElementById('meetingTitle');
        const meetingRoom = document.getElementById('meetingRoom');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const organizer = document.getElementById('organizer');
        const meetingDate = document.getElementById('meetingDate');
        const dateDisplay = document.getElementById('dateDisplay');
        
        if (meetingTitle) meetingTitle.value = '';
        if (meetingRoom) meetingRoom.value = '';
        if (startTime) startTime.value = '';
        if (endTime) endTime.value = '';
        if (organizer) organizer.value = '';
        if (meetingDate) meetingDate.value = '';
        if (dateDisplay) {
            dateDisplay.textContent = '請點擊選擇日期';
            dateDisplay.classList.add('placeholder');
            dateDisplay.classList.remove('has-value');
        }
        
        // 重設週期預約選項
        const recurringCheckbox = document.getElementById('recurringBooking');
        const recurringOptions = document.getElementById('recurringOptions');
        const recurringPeriod = document.getElementById('recurringPeriod');
        const monthlyModeOption = document.getElementById('monthlyModeOption');
        
        if (recurringCheckbox) {
            recurringCheckbox.checked = false;
        }
        
        // 隱藏週期預約相關選項
        if (recurringOptions) {
            recurringOptions.style.display = 'none';
        }
        if (recurringPeriod) {
            recurringPeriod.style.display = 'none';
        }
        if (monthlyModeOption) {
            monthlyModeOption.style.display = 'none';
        }
        
        // 重設週期預約的下拉選單為預設值
        const recurringType = document.getElementById('recurringType');
        const recurringWeeks = document.getElementById('recurringWeeks');
        
        if (recurringType) {
            recurringType.value = 'weekly'; // 恢復預設值
        }
        if (recurringWeeks) {
            recurringWeeks.value = '12'; // 恢復預設值
        }
	// 在 resetForm 函數中添加
	// 確保週期預約勾選框完全恢復正常狀態
	// 在 resetForm 函數中，使用已宣告的 recurringCheckbox
	const checkboxGroup = recurringCheckbox?.closest('.checkbox-group');

	if (recurringCheckbox && checkboxGroup) {
    	recurringCheckbox.disabled = false;
    	checkboxGroup.classList.remove('disabled');
    
   	 const notice = checkboxGroup.querySelector('.edit-mode-notice');
    	if (notice) {
        	notice.remove();
    	}
	}
        
        // 清空模式說明文字
        const modeExplanation = document.getElementById('modeExplanation');
        if (modeExplanation) {
            modeExplanation.textContent = '';
        }
        
        console.log('表單重設完成');
        
    } catch (error) {
        console.error('重設表單時發生錯誤:', error);
        // 即使發生錯誤也不要讓整個流程中斷
    }
}

// 預約提交函數 - 完整繁體中文版本
async function submitBooking() {
    try {
	// 如果是編輯模式，調用編輯函數
	if (isEditMode && currentEditingBooking) {
   	 return await updateBooking();
	}
        console.log('開始提交預約...');
        
        const title = document.getElementById('meetingTitle').value.trim();
        const room = document.getElementById('meetingRoom').value;
        const date = document.getElementById('meetingDate').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const organizer = document.getElementById('organizer').value.trim();
        const isRecurring = document.getElementById('recurringBooking').checked;
        const recurringType = document.getElementById('recurringType').value;
        const recurringWeeks = parseInt(document.getElementById('recurringWeeks').value);
        
        console.log('表單資料:', { title, room, date, startTime, endTime, organizer, isRecurring, recurringType, recurringWeeks });
        
        // 驗證必填欄位
        if (!title) { 
            showModal('預約失敗', '請填寫會議主題。'); 
            return; 
        }
        if (!room) { 
            showModal('預約失敗', '請選擇會議室。'); 
            return; 
        }
        if (!date) { 
            showModal('預約失敗', '請選擇日期。'); 
            return; 
        }
        if (!startTime) { 
            showModal('預約失敗', '請選擇開始時間。'); 
            return; 
        }
        if (!endTime) { 
            showModal('預約失敗', '請選擇結束時間。'); 
            return; 
        }
        if (!organizer) { 
            showModal('預約失敗', '請填寫登記者。'); 
            return; 
        }
        
        // 驗證時間邏輯
        if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
            showModal('預約失敗', '結束時間必須晚於開始時間。');
            return;
        }
        
        // 處理週期預約
        let datesToBook = [date];
        if (isRecurring) {
            if (!recurringType || isNaN(recurringWeeks)) {
                showModal('預約失敗', '請選擇週期預約的重複頻率和持續期間。');
                return;
            }
            console.log('產生週期預約日期...');
            datesToBook = generateRecurringDates(date, recurringType, recurringWeeks);
            console.log('週期預約日期:', datesToBook);
        }
        
        if (!datesToBook || datesToBook.length === 0) {
            showModal('預約失敗', '無法產生預約日期，請檢查日期設定。');
            return;
        }
        
        // 檢查衝突
        console.log('開始檢查衝突...');
        try {
            const conflicts = await checkRecurringConflicts(datesToBook, room, startTime, endTime);
            if (conflicts.length > 0) {
                let conflictMessage = '以下日期有衝突，無法預約：<br><br>';
                conflicts.forEach(conflict => {
                    conflictMessage += `📅 <strong>${conflict.date}</strong><br>`;
                    conflictMessage += `🏢 ${conflict.booking.room}<br>`;
                    conflictMessage += `⏰ ${formatTimeDisplay(conflict.booking.startTime)}-${formatTimeDisplay(conflict.booking.endTime)}<br>`;
                    conflictMessage += `📋 ${conflict.booking.title}<br>`;
                    conflictMessage += `👤 ${conflict.booking.organizer}<br><br>`;
                });
                showModal('預約失敗 - 時間衝突', conflictMessage);
                return;
            }
            console.log('衝突檢查通過');
        } catch (error) {
            console.error('衝突檢測失敗:', error);
            showModal('預約失敗', `衝突檢測時發生錯誤：<br><strong>${error.message}</strong><br><br>可能原因：<br>• 資料庫連線問題<br>• 網路連線不穩定<br><br>請稍後重試或聯絡系統管理員。`);
            return;
        }
        
        // 批量儲存預約
        console.log('開始儲存預約...');
        let successCount = 0;
        let failedDates = [];
        
        for (const bookingDate of datesToBook) {
            try {
                const booking = {
                    date: bookingDate,
                    room: room,
                    startTime: startTime,
                    endTime: endTime,
                    title: title,
                    organizer: organizer
                };
                
                const success = await saveBooking(booking);
                if (success) {
                    successCount++;
                    console.log(`預約成功: ${bookingDate}`);
                } else {
                    failedDates.push(bookingDate);
                    console.log(`預約失敗: ${bookingDate}`);
                }
            } catch (error) {
                failedDates.push(bookingDate);
                console.error(`儲存預約失敗 (${bookingDate}):`, error);
            }
        }
        
        // 顯示結果
        if (successCount > 0) {
            let successMessage;
            if (isRecurring) {
                // 智慧顯示期間文字
                let periodText;
                const recurringTypeValue = document.getElementById('recurringType').value;
if (recurringTypeValue === 'weekly') {
    if (recurringWeeks === 52) {
        periodText = '1年';
    } else if (recurringWeeks === 156) {
        periodText = '3年';
    } else if (recurringWeeks === 12) {
        periodText = '3個月';
    } else if (recurringWeeks === 24) {
        periodText = '6個月';
    } else {
        periodText = `${recurringWeeks}週`;
    }
} else if (recurringTypeValue === 'biweekly') {
    if (recurringWeeks === 52) {
        periodText = '12個月（1年）';
    } else if (recurringWeeks === 156) {
        periodText = '36個月（3年）';
    } else if (recurringWeeks === 26) {
        periodText = '6個月（半年）';
    } else if (recurringWeeks === 12) {
        periodText = '12週';
    } else if (recurringWeeks === 10) {
        periodText = '10週';
    } else if (recurringWeeks === 8) {
        periodText = '8週';
    } else if (recurringWeeks === 6) {
        periodText = '6週';
    } else if (recurringWeeks === 4) {
        periodText = '4週';
    } else {
        periodText = `${recurringWeeks}週`;
    }
} else if (recurringTypeValue === 'monthly') {
    if (recurringWeeks === 52) {
        periodText = '1年';
    } else if (recurringWeeks === 104) {
        periodText = '2年';
    } else if (recurringWeeks === 156) {
        periodText = '3年';
    } else if (recurringWeeks === 9) {
        periodText = '2個月';
    } else if (recurringWeeks === 13) {
        periodText = '3個月';
    } else if (recurringWeeks === 26) {
        periodText = '6個月';
    } else {
        periodText = `${recurringWeeks}週`;
    }
}                
                successMessage = `✅ <strong>成功預約 ${successCount} 場週期會議！</strong><br><br>`;
                successMessage += `📋 <strong>會議主題：</strong>${title}<br>`;
                successMessage += `⏰ <strong>時間：</strong>${startTime}-${endTime}<br>`;
                successMessage += `🏢 <strong>地點：</strong>${room}<br>`;
                successMessage += `👤 <strong>登記者：</strong>${organizer}<br>`;
		let frequencyText;
		if (recurringType === 'weekly') {
    			frequencyText = '每週';
		} else if (recurringType === 'biweekly') {
    			frequencyText = '每雙週';
		} else if (recurringType === 'monthly') {
    			frequencyText = '每月';
		} else {
    			frequencyText = recurringType;
		}
		successMessage += `🔁 <strong>頻率：</strong>${frequencyText}<br>`;
                successMessage += `📅 <strong>期間：</strong>${periodText}`;
                
                if (failedDates.length > 0) {
                    successMessage += `<br><br>⚠️ <strong>部分日期預約失敗：</strong><br>${failedDates.join(', ')}`;
                }
            } else {
                successMessage = `✅ <strong>預約成功！</strong><br><br>`;
                successMessage += `📋 <strong>會議主題：</strong>${title}<br>`;
                successMessage += `📅 <strong>日期：</strong>${date}<br>`;
                successMessage += `⏰ <strong>時間：</strong>${startTime}-${endTime}<br>`;
                successMessage += `🏢 <strong>地點：</strong>${room}<br>`;
                successMessage += `👤 <strong>登記者：</strong>${organizer}`;
            }
            
            showModal('預約成功！', successMessage);
            resetForm();
            
            // 重新載入資料以確保同步
            setTimeout(() => {
                loadBookings();
            }, 1000);
        } else {
            showModal('預約失敗', `所有預約都未能成功建立。<br><br>失敗的日期：<br>${failedDates.join('<br>')}<br><br>請檢查網路連線或稍後重試。`);
        }
        
    } catch (error) {
        console.error('提交預約時發生未預期的錯誤:', error);
        showModal('系統錯誤', `提交預約時發生未預期的錯誤：<br><strong>${error.message}</strong><br><br>請重新整理頁面後再試，或聯絡系統管理員。`);
    }
}

// 時間轉換函數 - 將 HH:MM 格式轉換為分鐘數
function timeToMinutes(timeStr) {
    if (!timeStr || typeof timeStr !== 'string') {
        console.warn('無效的時間格式:', timeStr);
        return 0;
    }
    
    // 處理 HH:MM:SS 格式，只取前面的 HH:MM
    if (timeStr.includes(':')) {
        const timeParts = timeStr.split(':');
        const hours = parseInt(timeParts[0]) || 0;
        const minutes = parseInt(timeParts[1]) || 0;
        const totalMinutes = hours * 60 + minutes;
        
        console.log(`時間轉換: ${timeStr} -> ${totalMinutes}分鐘`);
        return totalMinutes;
    }
    
    console.warn('無法解析時間格式:', timeStr);
    return 0;
}

// 產生週期預約日期函數
function generateRecurringDates(startDate, recurringType, weeks) {
    const dates = [];
    const baseDate = new Date(startDate);
    
    console.log(`產生週期日期 - 模式: ${recurringType}, 期間: ${weeks}週`);
    
    if (recurringType === 'weekly') {
        // 每週邏輯
        for (let i = 0; i < weeks; i++) {
            const nextDate = new Date(baseDate);
            nextDate.setDate(baseDate.getDate() + (i * 7));
            dates.push(formatDate(nextDate));
        }
    } else if (recurringType === 'biweekly') {
        // 每雙週邏輯（每14天）
        const totalOccurrences = Math.ceil(weeks / 2); // 雙週次數
        for (let i = 0; i < totalOccurrences; i++) {
            const nextDate = new Date(baseDate);
            nextDate.setDate(baseDate.getDate() + (i * 14)); // 每14天
            dates.push(formatDate(nextDate));
        }
    } else if (recurringType === 'monthly') {
        // 每月邏輯 - 使用相對週日模式
        const totalMonths = Math.round(weeks / 4.33); // 將週數轉換為大概的月數
        
        for (let i = 0; i < totalMonths; i++) {
            // 使用相對週日模式：每月第N個週X
            const nextDate = calculateRelativeWeeklyDate(baseDate, i);
            dates.push(formatDate(nextDate));
            console.log(`月份 ${i}: ${nextDate.toDateString()}`);
        }
    }
    
    console.log(`總共產生 ${dates.length} 個日期:`, dates);
    return dates;
}

// 更新預約函數
async function updateBooking() {
    try {
        const title = document.getElementById('meetingTitle').value.trim();
        const room = document.getElementById('meetingRoom').value;
        const date = document.getElementById('meetingDate').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const organizer = document.getElementById('organizer').value.trim();
        
        console.log('開始更新預約:', { title, room, date, startTime, endTime, organizer, editMode });
        
        // 基本驗證
        if (!title || !room || !date || !startTime || !endTime || !organizer) {
            showModal('更新失敗', '請填寫所有必填欄位。');
            return;
        }
        
        if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
            showModal('更新失敗', '結束時間必須晚於開始時間。');
            return;
        }
        
        showLoading(true);
        
        try {
            if (editMode === 'single') {
                // 單次編輯衝突檢查
                console.log('執行單次編輯衝突檢查...');
                const conflicts = await checkSingleEditConflicts(
                    currentEditingBooking.id, 
                    date, 
                    room, 
                    startTime, 
                    endTime
                );
                
                if (conflicts.length > 0) {
                    showEditConflictModal(conflicts, false);
                    return;
                }
                
                await updateSingleBooking(title, room, date, startTime, endTime, organizer);
                
            } else if (editMode === 'series') {
                // 系列編輯衝突檢查
                console.log('執行系列編輯衝突檢查...');
                const seriesIds = futureBookingsToEdit.map(b => b.id);
                const dates = futureBookingsToEdit.map(b => b.date);
                
                const conflictStats = await checkSeriesEditConflicts(
                    seriesIds,
                    dates,
                    room,
                    startTime,
                    endTime
                );
                
                if (conflictStats.conflictDates > 0) {
                    showSeriesEditConflictModal(conflictStats);
                    return;
                }
                
                await updateSeriesBookings(title, room, startTime, endTime, organizer);
            }
            
        } catch (error) {
            console.error('衝突檢查過程發生錯誤:', error);
            showModal('衝突檢查失敗', `無法檢查衝突：${error.message}<br><br>請檢查網路連線後重試。`);
        }
        
    } catch (error) {
        console.error('更新失敗:', error);
        showModal('更新失敗', `無法更新預約：${error.message}`);
    } finally {
        showLoading(false);
    }
}


        // 單次更新
        async function updateSingleBooking(title, room, date, startTime, endTime, organizer) {
            const { error } = await supabaseClient
                .from('bookings')
                .update({
                    title: title,
                    room: room,
                    date: date,
                    start_time: startTime,
                    end_time: endTime,
                    organizer: organizer
                })
                .eq('id', currentEditingBooking.id);
            
            if (error) throw error;
            
            showModal('更新成功', `預約已成功更新！<br><br>📋 ${title}`);
            cancelEdit();
            setTimeout(() => loadBookings(), 1000);
        }

       // 系列更新（修正版）
        async function updateSeriesBookings(title, room, startTime, endTime, organizer) {
    // === 除錯資訊 ===
    console.log('=== 系列更新除錯 ===');
    console.log('1. futureBookingsToEdit:', futureBookingsToEdit);
    console.log('2. 長度:', futureBookingsToEdit.length);
    console.log('3. 第一個預約:', futureBookingsToEdit[0]);
    console.log('4. 最後一個預約:', futureBookingsToEdit[futureBookingsToEdit.length-1]);
    console.log('5. 所有 ID:', futureBookingsToEdit.map(b => b.id));
    // === 除錯結束 ===
            // 確認操作
            const confirmed = confirm(
                `確定要修改 ${futureBookingsToEdit.length} 個預約嗎？\n\n` +
                `影響日期：${futureBookingsToEdit[0]?.date} 至 ${futureBookingsToEdit[futureBookingsToEdit.length-1]?.date}\n\n` +
                `這將無法撤銷。`
            );
            
            if (!confirmed) {
                showLoading(false);
                return;
            }
            
            console.log('開始批量更新預約...', futureBookingsToEdit);
            
            // 批量更新邏輯：逐一更新每個預約
            let successCount = 0;
            let failedCount = 0;
            
            for (const booking of futureBookingsToEdit) {
                try {
                    const { error } = await supabaseClient
                        .from('bookings')
                        .update({
                            title: title,
                            room: room,
                            start_time: startTime,
                            end_time: endTime,
                            organizer: organizer
                            // 保持原有日期不變
                        })
                        .eq('id', booking.id);
                    
                    if (error) {
                        console.error(`更新預約 ${booking.id} 失敗:`, error);
                        failedCount++;
                    } else {
                        console.log(`更新預約 ${booking.id} 成功`);
                        successCount++;
                    }
                } catch (error) {
                    console.error(`更新預約 ${booking.id} 時發生錯誤:`, error);
                    failedCount++;
                }
            }
            
            // 顯示結果
            if (successCount > 0) {
                const message = failedCount > 0 ? 
                    `✅ 成功更新 ${successCount} 個預約<br>❌ ${failedCount} 個預約更新失敗` :
                    `✅ <strong>成功更新 ${successCount} 個預約！</strong><br><br>` +
                    `📋 <strong>會議主題：</strong>${title}<br>` +
                    `🏢 <strong>地點：</strong>${room}<br>` +
                    `⏰ <strong>時間：</strong>${startTime}-${endTime}<br>` +
                    `👤 <strong>登記者：</strong>${organizer}<br><br>` +
                    `📅 <strong>影響範圍：</strong>${futureBookingsToEdit[0]?.date} 至 ${futureBookingsToEdit[futureBookingsToEdit.length-1]?.date}`;
                
                showModal('批量更新完成', message);
                cancelEdit();
                setTimeout(() => loadBookings(), 1000);
            } else {
                showModal('更新失敗', '所有預約更新都失敗了，請稍後重試。');
            }
        }

        
	// 通知函數 - 支持不同類型
	function showNotification(message, type = 'success', duration = 3000) {
    	const notification = document.createElement('div');
   	 notification.style.cssText = `
       	 position: fixed;
       	 top: 20px;
       	 right: 20px;
      	  padding: 15px 20px;
       	 border-radius: 5px;
       	 z-index: 2000;
       	 box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      	  max-width: 300px;
       	 font-size: 14px;
       	 line-height: 1.4;
   	 `;
    
   	 // 根據類型設定顏色
   	 switch(type) {
       	 case 'success':
           	 notification.style.background = '#28a745';
           	 notification.style.color = 'white';
           	 break;
       	 case 'warning':
           	 notification.style.background = '#ffc107';
           	 notification.style.color = '#212529';
           	 break;
         case 'info':
            	notification.style.background = '#17a2b8';
            	notification.style.color = 'white';
           	 break;
        	default:
           	 notification.style.background = '#28a745';
           	 notification.style.color = 'white';
    	}
    
   	 notification.textContent = message;
   	 document.body.appendChild(notification);
    
    	setTimeout(() => {
      	  if (notification.parentNode) {
      	      notification.remove();
      	  }
   	 }, duration);
	}
// 模態框函數
function showModal(title, message, onConfirm = null) {
    const modal = document.getElementById('bookingModal');
    const modalTitle = document.querySelector('#bookingModal h3');
    const modalMessage = document.getElementById('modalMessage');
    const modalContent = document.querySelector('#bookingModal .modal-content');
    
    modalTitle.textContent = title;
    modalMessage.innerHTML = message;
    
    // 移除舊的按鈕
    const oldButtons = modalContent.querySelectorAll('.modal-buttons');
    oldButtons.forEach(btn => btn.remove());
    
    // 創建按鈕容器
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'modal-buttons';
    buttonContainer.style.cssText = `
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
    `;
    
    if (onConfirm) {
        // 有確認回調時，顯示確定和取消按鈕
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '取消';
        cancelBtn.style.cssText = `
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 80px;
        `;
        cancelBtn.onclick = closeModal;
        
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = '刪除';
        confirmBtn.style.cssText = `
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 80px;
        `;
        confirmBtn.onclick = () => {
            closeModal();
            onConfirm();
        };
        
        buttonContainer.appendChild(cancelBtn);
        buttonContainer.appendChild(confirmBtn);
    } else {
        // 沒有確認回調時，只顯示確認按鈕
        const okBtn = document.createElement('button');
        okBtn.textContent = '確認';
        okBtn.className = 'btn';
        okBtn.onclick = closeModal;
        buttonContainer.appendChild(okBtn);
    }
    
    modalContent.appendChild(buttonContainer);
    modal.style.display = 'block';
}
        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        // 修正的載入函數
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = show;
            }
        }

        // 事件監聽器設定
        function setupEventListeners() {
            // 基本事件
            document.getElementById('meetingDate').addEventListener('change', updateDateDisplay);
            
            // 開始時間變更，自動設定結束時間
            document.getElementById('startTime').addEventListener('change', function() {
                const startTime = this.value;
                if (startTime) {
                    const [hour, minute] = startTime.split(':').map(Number);
                    let endHour = hour;
                    let endMinute = minute + 30;
                    
                    if (endMinute >= 60) {
                        endHour += 1;
                        endMinute = 0;
                    }
                    
                    if (endHour > 18) {
                        endHour = 18;
                        endMinute = 0;
                    }
                    
                    const endTime = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
                    document.getElementById('endTime').value = endTime;
                }
            });
            
            // 週期預約勾選監聽
            const recurringCheckbox = document.getElementById('recurringBooking');
            if (recurringCheckbox) {
                recurringCheckbox.addEventListener('change', function() {
                    const recurringOptions = document.getElementById('recurringOptions');
                    const recurringPeriod = document.getElementById('recurringPeriod');
                    
                    if (this.checked) {
                        recurringOptions.style.display = 'block';
                        recurringPeriod.style.display = 'block';
                        // 初始化持續期間選項
                        console.log('週期預約已勾選，初始化選項');
                        updateRecurringPeriodOptions();
                    } else {
                        recurringOptions.style.display = 'none';
                        recurringPeriod.style.display = 'none';
                    }
                });
            }
            
            // 重複頻率變更監聽
            const recurringTypeSelect = document.getElementById('recurringType');
            if (recurringTypeSelect) {
                recurringTypeSelect.addEventListener('change', function() {
                    console.log('重複頻率已變更為:', this.value);
                    updateRecurringPeriodOptions();
                });
            }
            
            // 模態框關閉監聽
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            const bookingModalElement = document.getElementById('bookingModal');
            if (bookingModalElement) {
                bookingModalElement.addEventListener('click', function(e) {
                    if (e.target === this) closeModal();
                });
            }
            
            // 週期刪除模態框關閉監聽
            const recurringModalElement = document.getElementById('recurringDeleteModal');
            if (recurringModalElement) {
                recurringModalElement.addEventListener('click', function(e) {
                    if (e.target === this) closeRecurringModal();
                });
            }
            
            // 點擊外部關閉日曆選單
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.calendar-dropdown')) {
                    hideAllCalendarMenus();
                }
            });
            
            console.log('基本事件監聽器已設定完成');
	    setupEditConflictEventListeners();
        }

        // 設定額外的日期相關事件監聽器
        function setupAdditionalDateEvents() {
            const dateInput = document.getElementById('meetingDate');
            const dateDisplay = document.getElementById('dateDisplay');
            const dateContainer = document.querySelector('.date-picker-container');
            
            if (!dateInput || !dateDisplay || !dateContainer) {
                console.warn('找不到日期相關元素');
                return;
            }
            
            // 日期輸入變更事件
            dateInput.addEventListener('input', updateDateDisplay);
            
            // 點擊顯示區域開啟選擇器
            dateDisplay.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('點擊日期顯示區域');
                openDatePicker();
            });
            
            // 容器點擊事件
            dateContainer.addEventListener('click', function(e) {
                if (e.target !== dateDisplay) {
                    console.log('點擊日期容器');
                    openDatePicker();
                }
            });
            
            // 鍵盤支援
            dateDisplay.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    console.log('鍵盤觸發日期選擇器');
                    openDatePicker();
                }
            });
            
            // 觸控事件（移動設備）
            let touchStartTime = 0;
            
            dateDisplay.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                console.log('觸控開始');
            }, { passive: true });
            
            dateDisplay.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 500) {
                    e.preventDefault();
                    console.log('短觸控觸發日期選擇器');
                    openDatePicker();
                }
            });
            
            // 焦點視覺反饋
            dateInput.addEventListener('focus', function() {
                console.log('日期輸入獲得焦點');
                dateDisplay.style.borderColor = '#2d4874';
            });
            
            dateInput.addEventListener('blur', function() {
                console.log('日期輸入失去焦點');
                dateDisplay.style.borderColor = '#e2e8f0';
            });
            
            console.log('日期相關事件監聽器已設定');
	  // 編輯模式模態框關閉監聽
            const editModeModalElement = document.getElementById('editModeModal');
            if (editModeModalElement) {
                editModeModalElement.addEventListener('click', function(e) {
                    if (e.target === this) closeEditModeModal();
                });
            }
        }

// 手機端懸浮按鈕滾動到表單功能
function scrollToForm() {
    // 如果正在編輯模式，先取消編輯
    if (isEditMode) {
        console.log('取消編輯模式以開始新預約');
        cancelEdit();
    }
    
    // 確保表單為新增模式
    resetForm();
    
    // 滾動到表單區域
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
        
        // 延遲聚焦到第一個輸入框
        setTimeout(() => {
            const firstInput = document.getElementById('meetingTitle');
            if (firstInput) {
                firstInput.focus();
            }
        }, 500);
    }
    
    // 提供視覺反饋
    showNotification('請填寫預約資訊', 'info', 2000);
    
    console.log('懸浮按鈕觸發：滾動到表單區域');
}

// 增強的初始化函數，包含多重檢查
        function initialize() {
            console.log('開始初始化系統...');
            
            initializeTimeSelects();
            setupEventListeners();
            setupAdditionalDateEvents();
            
            // 更新週別顯示
            updateWeekDisplay();
            
            // 初始化空的表格
            updateSchedule();
            
            // 初始化 Supabase 並載入資料
            initializeSupabase();
            
            // 初始化懸浮按鈕（多重檢查）
            initializeFloatingButton();
            
            console.log('系統初始化完成');
        }

        // 專門的懸浮按鈕初始化函數
        function initializeFloatingButton() {
            console.log('開始初始化懸浮按鈕...');
            
            // 立即執行一次
            ensureFloatingButton();
            
            // DOM 完全載入後再執行
            setTimeout(() => {
                ensureFloatingButton();
                
                // 最終檢查
                setTimeout(() => {
                    const device = detectAdvancedDevice();
                    console.log('設備詳細信息:', device);
                    
                    if (device.isMobileDevice()) {
                        forceShowFloatingButton();
                    }
                }, 1000);
            }, 500);
            
            // 視窗大小改變時重新檢查
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    console.log('視窗大小改變，重新檢查懸浮按鈕');
                    ensureFloatingButton();
                }, 250);
            });
        }

        // 強制顯示懸浮按鈕的最後手段
        function forceShowFloatingButton() {
            console.log('執行懸浮按鈕強制顯示...');
            
            let button = document.getElementById('floatingAddBtn');
            if (!button) {
                console.log('按鈕不存在，創建新按鈕');
                button = document.createElement('button');
                button.id = 'floatingAddBtn';
                button.innerHTML = '+';
                button.onclick = scrollToForm;
                document.body.appendChild(button);
            }
            
            // 使用 setAttribute 強制設定樣式
            const forceStyles = [
                ['style', 'position: fixed !important; bottom: 20px !important; right: 20px !important; width: 56px !important; height: 56px !important; z-index: 2147483647 !important; display: flex !important; align-items: center !important; justify-content: center !important; background: linear-gradient(135deg, #2d4874 0%, #1a2e4a 100%) !important; border: none !important; border-radius: 50% !important; color: white !important; font-size: 28px !important; font-weight: 300 !important; cursor: pointer !important; box-shadow: 0 4px 16px rgba(45, 72, 116, 0.6) !important; transition: all 0.3s ease !important;']
            ];
            
            forceStyles.forEach(([attr, value]) => {
                button.setAttribute(attr, value);
            });
            
            // 移除所有可能衝突的類別
            button.className = '';
            
            // 確保按鈕在 body 的最後位置
            document.body.appendChild(button);
            
            console.log('強制顯示完成，按鈕當前狀態:', {
                exists: !!button,
                display: button.style.display,
                position: button.style.position,
                zIndex: button.style.zIndex,
                bottom: button.style.bottom,
                right: button.style.right,
                computedStyle: getComputedStyle(button).display
            });
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initialize);  
  

</script>

<!-- 編輯模式選擇模態框 -->
    <div id="editModeModal" class="edit-mode-modal">
        <div class="edit-mode-modal-content">
            <h3>🔧 編輯預約</h3>
            
            <div class="booking-info" id="editBookingInfo">
                <!-- 動態填入預約資訊 -->
            </div>
            
            <div class="mode-buttons">
                <button class="mode-btn mode-btn-single" onclick="confirmEditMode('single')">
                    📝 只編輯此次
                    <small id="singleEditDesc">僅修改這一場會議</small>
                </button>
                
                <button class="mode-btn mode-btn-series" onclick="confirmEditMode('series')">
                    🔄 編輯未來系列
                    <small id="seriesEditDesc">修改從此次開始的所有後續會議</small>
                </button>
                
                <button class="mode-btn mode-btn-cancel" onclick="closeEditModeModal()">
                   ❌ 取消
                </button>
            </div>
        </div>
    </div>
		<!-- 手機端懸浮新增按鈕 -->
		<button class="floating-add-btn" id="floatingAddBtn" onclick="scrollToForm()">
  		  +
		</button>
 
</body>
</html>
